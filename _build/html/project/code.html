
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Project Code (Heart Disease Prediction) &#8212; EAS503 Heart Disease Prediction Project</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'project/code';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Project Resources and Links" href="../resources/links.html" />
    <link rel="prev" title="Heart Disease Prediction Project" href="project_overview.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="EAS503 Heart Disease Prediction Project - Home"/>
    <img src="../_static/logo.png" class="logo__image only-dark pst-js-only" alt="EAS503 Heart Disease Prediction Project - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome to the Heart Disease Prediction Book
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../resume/resume.html">Rohan Jain - Resume</a></li>
<li class="toctree-l1"><a class="reference internal" href="project_overview.html">Heart Disease Prediction Project</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Project Code (Heart Disease Prediction)</a></li>











<li class="toctree-l1"><a class="reference internal" href="../resources/links.html">Project Resources and Links</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fproject/code.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/project/code.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Project Code (Heart Disease Prediction)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Project Code (Heart Disease Prediction)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-normalized-database-3nf">Create a normalized database (3NF).</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#write-sql-join-statement-to-fetch-data-from-the-database-and-into-pandas-dataframe">Write SQL join statement to fetch data from the database and into Pandas DataFrame.</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#explore-the-data-using-yprofile-and-correlation-matrix-make-observations-about-features-distributions-capped-values-and-missing-values-create-a-list-of-data-cleanup-tasks">Explore the data using yprofile and correlation matrix. Make observations about features, distributions, capped values, and missing values. Create a list of data cleanup tasks.</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#explore-the-data-to-determine-if-you-need-to-stratify-it-by-some-attribute-when-doing-train-test-split-perform-the-train-test-split">Explore the data to determine if you need to stratify it by some attribute when doing train/test split. Perform the train/test split.</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-1-create-a-pipeline-for-preprocessing-standardscaler-minmaxscaler-logtransformation-onehotencoding-and-logistic-regression-log-f1-score-tp-tn-fn-fp-in-mlflow-on-dagshub-cross-validation-3-10-folds-resultsmean-std-of-cv-results-and-results-on-the-whole-training-data-add-in-parameter-hyper-tuning">Experiment #1: Create a pipeline for preprocessing (StandardScaler, MinMaxScaler, LogTransformation, OneHotEncoding) and Logistic Regression. Log F1-score/(TP,TN,FN,FP)  in MLFlow on DagsHub. – Cross validation 3/10 folds. Results—mean/std of CV results and results on the whole training data – add in parameter hyper tuning</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-2-create-a-pipeline-for-preprocessing-and-use-logisticregression-ridgeclassifier-randomforestclassifier-and-xgbclassifier-log-results-in-mlflow-on-dagshub">Experiment #2: Create a pipeline for preprocessing and use LogisticRegression, RidgeClassifier, RandomForestClassifier, and XGBClassifier. Log results in MLFlow on DagsHub.</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-3-perform-feature-engineering-and-attribute-combination-log-results-in-mlflow">Experiment #3: Perform feature engineering and attribute combination. Log results in MLFlow.</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-4-perform-feature-selection-using-correlation-threshold-feature-importance-and-variance-threshold-log-results-in-mlflow">Experiment #4: Perform feature selection using Correlation Threshold, Feature Importance, and Variance Threshold. Log results in MLFlow.</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-5-use-pca-for-dimensionality-reduction-on-all-the-features-create-a-scree-plot-to-show-which-components-will-be-selected-for-classification-log-results-in-mlflow">Experiment #5: Use PCA for dimensionality reduction on all the features. Create a scree plot to show which components will be selected for classification. Log results in MLFlow.</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-6-design-a-nd-execute-a-custom-experiment-log-results-in-mlflow">Experiment #6: Design a nd execute a custom experiment. Log results in MLFlow.</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-7-design-and-execute-another-custom-experiment-log-results-in-mlflow">Experiment #7: Design and execute another custom experiment. Log results in MLFlow.</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="project-code-heart-disease-prediction">
<h1>Project Code (Heart Disease Prediction)<a class="headerlink" href="#project-code-heart-disease-prediction" title="Link to this heading">#</a></h1>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="create-a-normalized-database-3nf">
<h1>Create a normalized database (3NF).<a class="headerlink" href="#create-a-normalized-database-3nf" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">from</span> <span class="nn">sqlite3</span> <span class="kn">import</span> <span class="n">Error</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="c1"># Function to create a database connecti`on</span>
<span class="k">def</span> <span class="nf">create_connection</span><span class="p">(</span><span class="n">db_file</span><span class="p">,</span> <span class="n">delete_db</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">delete_db</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">db_file</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db_file</span><span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;PRAGMA foreign_keys = 1&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">conn</span>

<span class="c1"># Function to create tables</span>
<span class="k">def</span> <span class="nf">create_table</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">create_table_sql</span><span class="p">,</span> <span class="n">drop_table_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">drop_table_name</span><span class="p">:</span>  <span class="c1"># Drop table if specified</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DROP TABLE IF EXISTS </span><span class="si">{</span><span class="n">drop_table_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">create_table_sql</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">Error</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="kn">from</span> <span class="nn">sqlite3</span> <span class="kn">import</span> <span class="n">Error</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;pandas&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Database and file paths</span>
<span class="n">db_name</span> <span class="o">=</span> <span class="s1">&#39;/Users/rohanjain/Desktop/Sem1/Prog_DB/Final project/heart_disease_database.db&#39;</span>
<span class="n">csv_file_path</span> <span class="o">=</span> <span class="s1">&#39;/Users/rohanjain/Desktop/Sem1/Prog_DB/Final_project/heart_disease.csv&#39;</span>

<span class="c1"># Load the CSV data</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_file_path</span><span class="p">)</span>

<span class="c1"># Split the data into normalized tables</span>
<span class="c1"># Patient_Info Table</span>
<span class="n">patient_info</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;sex&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;patient_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">patient_info</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Medical_Record Table</span>
<span class="n">medical_record</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;chest pain type&#39;</span><span class="p">,</span> <span class="s1">&#39;resting bp s&#39;</span><span class="p">,</span> <span class="s1">&#39;cholesterol&#39;</span><span class="p">,</span> <span class="s1">&#39;fasting blood sugar&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">medical_record</span><span class="p">[</span><span class="s1">&#39;patient_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">medical_record</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Test_Results Table</span>
<span class="n">test_results</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;resting ecg&#39;</span><span class="p">,</span> <span class="s1">&#39;max heart rate&#39;</span><span class="p">,</span> <span class="s1">&#39;exercise angina&#39;</span><span class="p">,</span> <span class="s1">&#39;oldpeak&#39;</span><span class="p">,</span> <span class="s1">&#39;ST slope&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">test_results</span><span class="p">[</span><span class="s1">&#39;patient_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_results</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># Diagnosis Table</span>
<span class="n">diagnosis</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;target&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">diagnosis</span><span class="p">[</span><span class="s1">&#39;patient_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">diagnosis</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create database connection</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">create_connection</span><span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">delete_db</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Create tables</span>
<span class="n">create_table</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">CREATE TABLE Patient_Info (</span>
<span class="s2">    patient_id INTEGER PRIMARY KEY,</span>
<span class="s2">    age INTEGER,</span>
<span class="s2">    sex INTEGER</span>
<span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">drop_table_name</span><span class="o">=</span><span class="s2">&quot;Patient_Info&quot;</span><span class="p">)</span>

<span class="n">create_table</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">CREATE TABLE Medical_Record (</span>
<span class="s2">    patient_id INTEGER PRIMARY KEY,</span>
<span class="s2">    [chest pain type] INTEGER,</span>
<span class="s2">    [resting bp s] INTEGER,</span>
<span class="s2">    cholesterol INTEGER,</span>
<span class="s2">    [fasting blood sugar] INTEGER</span>
<span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">drop_table_name</span><span class="o">=</span><span class="s2">&quot;Medical_Record&quot;</span><span class="p">)</span>

<span class="n">create_table</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">CREATE TABLE Test_Results (</span>
<span class="s2">    patient_id INTEGER PRIMARY KEY,</span>
<span class="s2">    [resting ecg] INTEGER,</span>
<span class="s2">    [max heart rate] INTEGER,</span>
<span class="s2">    [exercise angina] INTEGER,</span>
<span class="s2">    oldpeak REAL,</span>
<span class="s2">    [ST slope] INTEGER</span>
<span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">drop_table_name</span><span class="o">=</span><span class="s2">&quot;Test_Results&quot;</span><span class="p">)</span>

<span class="n">create_table</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">CREATE TABLE Diagnosis (</span>
<span class="s2">    patient_id INTEGER PRIMARY KEY,</span>
<span class="s2">    target INTEGER</span>
<span class="s2">)</span>
<span class="s2">&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">drop_table_name</span><span class="o">=</span><span class="s2">&quot;Diagnosis&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="write-sql-join-statement-to-fetch-data-from-the-database-and-into-pandas-dataframe">
<h1>Write SQL join statement to fetch data from the database and into Pandas DataFrame.<a class="headerlink" href="#write-sql-join-statement-to-fetch-data-from-the-database-and-into-pandas-dataframe" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Populate tables</span>
<span class="n">patient_info</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;Patient_Info&#39;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">medical_record</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;Medical_Record&#39;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">test_results</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;Test_Results&#39;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">diagnosis</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="s1">&#39;Diagnosis&#39;</span><span class="p">,</span> <span class="n">conn</span><span class="p">,</span> <span class="n">if_exists</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Database tables created and populated.&quot;</span><span class="p">)</span>

<span class="c1"># Join query to combine the four tables</span>
<span class="n">query</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">SELECT </span>
<span class="s2">    p.patient_id,</span>
<span class="s2">    p.age,</span>
<span class="s2">    p.sex,</span>
<span class="s2">    m.[chest pain type],</span>
<span class="s2">    m.[resting bp s],</span>
<span class="s2">    m.cholesterol,</span>
<span class="s2">    m.[fasting blood sugar],</span>
<span class="s2">    t.[resting ecg],</span>
<span class="s2">    t.[max heart rate],</span>
<span class="s2">    t.[exercise angina],</span>
<span class="s2">    t.oldpeak,</span>
<span class="s2">    t.[ST slope],</span>
<span class="s2">    d.target</span>
<span class="s2">FROM </span>
<span class="s2">    Patient_Info p</span>
<span class="s2">JOIN </span>
<span class="s2">    Medical_Record m ON p.patient_id = m.patient_id</span>
<span class="s2">JOIN </span>
<span class="s2">    Test_Results t ON p.patient_id = t.patient_id</span>
<span class="s2">JOIN </span>
<span class="s2">    Diagnosis d ON p.patient_id = d.patient_id;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># Execute the query and fetch the data</span>
<span class="n">df_combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql_query</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>

<span class="c1"># Close the connection</span>
<span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Database tables created and populated.
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="explore-the-data-using-yprofile-and-correlation-matrix-make-observations-about-features-distributions-capped-values-and-missing-values-create-a-list-of-data-cleanup-tasks">
<h1>Explore the data using yprofile and correlation matrix. Make observations about features, distributions, capped values, and missing values. Create a list of data cleanup tasks.<a class="headerlink" href="#explore-the-data-using-yprofile-and-correlation-matrix-make-observations-about-features-distributions-capped-values-and-missing-values-create-a-list-of-data-cleanup-tasks" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_combined</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>patient_id</th>
      <th>age</th>
      <th>sex</th>
      <th>chest pain type</th>
      <th>resting bp s</th>
      <th>cholesterol</th>
      <th>fasting blood sugar</th>
      <th>resting ecg</th>
      <th>max heart rate</th>
      <th>exercise angina</th>
      <th>oldpeak</th>
      <th>ST slope</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>40</td>
      <td>1</td>
      <td>2</td>
      <td>140</td>
      <td>289</td>
      <td>0</td>
      <td>0</td>
      <td>172</td>
      <td>0</td>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>49</td>
      <td>0</td>
      <td>3</td>
      <td>160</td>
      <td>180</td>
      <td>0</td>
      <td>0</td>
      <td>156</td>
      <td>0</td>
      <td>1.0</td>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>37</td>
      <td>1</td>
      <td>2</td>
      <td>130</td>
      <td>283</td>
      <td>0</td>
      <td>1</td>
      <td>98</td>
      <td>0</td>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>48</td>
      <td>0</td>
      <td>4</td>
      <td>138</td>
      <td>214</td>
      <td>0</td>
      <td>0</td>
      <td>108</td>
      <td>1</td>
      <td>1.5</td>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>54</td>
      <td>1</td>
      <td>3</td>
      <td>150</td>
      <td>195</td>
      <td>0</td>
      <td>0</td>
      <td>122</td>
      <td>0</td>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1190, 13)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">clean_column_names</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">clean_column_names</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>patient_id</th>
      <th>age</th>
      <th>sex</th>
      <th>chest_pain_type</th>
      <th>resting_bp_s</th>
      <th>cholesterol</th>
      <th>fasting_blood_sugar</th>
      <th>resting_ecg</th>
      <th>max_heart_rate</th>
      <th>exercise_angina</th>
      <th>oldpeak</th>
      <th>st_slope</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>40</td>
      <td>1</td>
      <td>2</td>
      <td>140</td>
      <td>289</td>
      <td>0</td>
      <td>0</td>
      <td>172</td>
      <td>0</td>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>49</td>
      <td>0</td>
      <td>3</td>
      <td>160</td>
      <td>180</td>
      <td>0</td>
      <td>0</td>
      <td>156</td>
      <td>0</td>
      <td>1.0</td>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>37</td>
      <td>1</td>
      <td>2</td>
      <td>130</td>
      <td>283</td>
      <td>0</td>
      <td>1</td>
      <td>98</td>
      <td>0</td>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>48</td>
      <td>0</td>
      <td>4</td>
      <td>138</td>
      <td>214</td>
      <td>0</td>
      <td>0</td>
      <td>108</td>
      <td>1</td>
      <td>1.5</td>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>54</td>
      <td>1</td>
      <td>3</td>
      <td>150</td>
      <td>195</td>
      <td>0</td>
      <td>0</td>
      <td>122</td>
      <td>0</td>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>patient_id             0
age                    0
sex                    0
chest_pain_type        0
resting_bp_s           0
cholesterol            0
fasting_blood_sugar    0
resting_ecg            0
max_heart_rate         0
exercise_angina        0
oldpeak                0
st_slope               0
target                 0
dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        patient_id          age          sex  chest_pain_type  resting_bp_s  \
count  1190.000000  1190.000000  1190.000000      1190.000000   1190.000000   
mean    595.500000    53.720168     0.763866         3.232773    132.153782   
std     343.667717     9.358203     0.424884         0.935480     18.368823   
min       1.000000    28.000000     0.000000         1.000000      0.000000   
25%     298.250000    47.000000     1.000000         3.000000    120.000000   
50%     595.500000    54.000000     1.000000         4.000000    130.000000   
75%     892.750000    60.000000     1.000000         4.000000    140.000000   
max    1190.000000    77.000000     1.000000         4.000000    200.000000   

       cholesterol  fasting_blood_sugar  resting_ecg  max_heart_rate  \
count  1190.000000          1190.000000  1190.000000     1190.000000   
mean    210.363866             0.213445     0.698319      139.732773   
std     101.420489             0.409912     0.870359       25.517636   
min       0.000000             0.000000     0.000000       60.000000   
25%     188.000000             0.000000     0.000000      121.000000   
50%     229.000000             0.000000     0.000000      140.500000   
75%     269.750000             0.000000     2.000000      160.000000   
max     603.000000             1.000000     2.000000      202.000000   

       exercise_angina      oldpeak     st_slope       target  
count      1190.000000  1190.000000  1190.000000  1190.000000  
mean          0.387395     0.922773     1.624370     0.528571  
std           0.487360     1.086337     0.610459     0.499393  
min           0.000000    -2.600000     0.000000     0.000000  
25%           0.000000     0.000000     1.000000     0.000000  
50%           0.000000     0.600000     2.000000     1.000000  
75%           1.000000     1.600000     2.000000     1.000000  
max           1.000000     6.200000     3.000000     1.000000  
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>patient_id               int64
age                      int64
sex                      int64
chest_pain_type          int64
resting_bp_s             int64
cholesterol              int64
fasting_blood_sugar      int64
resting_ecg              int64
max_heart_rate           int64
exercise_angina          int64
oldpeak                float64
st_slope                 int64
target                   int64
dtype: object
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Value counts for categorical columns</span>
<span class="n">categorical_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;chest_pain_type&#39;</span><span class="p">,</span> <span class="s1">&#39;fasting_blood_sugar&#39;</span><span class="p">,</span> <span class="s1">&#39;resting_ecg&#39;</span><span class="p">,</span> <span class="s1">&#39;exercise_angina&#39;</span><span class="p">,</span> <span class="s1">&#39;st_slope&#39;</span><span class="p">,</span> <span class="s1">&#39;target&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">categorical_columns</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value Counts for </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Value Counts for sex:
sex
1    909
0    281
Name: count, dtype: int64

Value Counts for chest_pain_type:
chest_pain_type
4    625
3    283
2    216
1     66
Name: count, dtype: int64

Value Counts for fasting_blood_sugar:
fasting_blood_sugar
0    936
1    254
Name: count, dtype: int64

Value Counts for resting_ecg:
resting_ecg
0    684
2    325
1    181
Name: count, dtype: int64

Value Counts for exercise_angina:
exercise_angina
0    729
1    461
Name: count, dtype: int64

Value Counts for st_slope:
st_slope
2    582
1    526
3     81
0      1
Name: count, dtype: int64

Value Counts for target:
target
1    629
0    561
Name: count, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Display correlation matrix</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">corr</span><span class="p">(),</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.2f&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Correlation Matrix&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/52d76ca775d38725fbfcad525a0c92cc93bc2117558a900fdebc514eb5ec5353.png" src="../_images/52d76ca775d38725fbfcad525a0c92cc93bc2117558a900fdebc514eb5ec5353.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">correlation_matrix</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>

<span class="c1"># Print the Correlation Table</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Correlation Table:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">correlation_matrix</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Correlation Table:
                     patient_id       age       sex  chest_pain_type  \
patient_id             1.000000  0.204412 -0.101410         0.008365   
age                    0.204412  1.000000  0.015096         0.149055   
sex                   -0.101410  0.015096  1.000000         0.138405   
chest_pain_type        0.008365  0.149055  0.138405         1.000000   
resting_bp_s          -0.002289  0.257692 -0.006443         0.009466   
cholesterol            0.217898 -0.046472 -0.208441        -0.109396   
fasting_blood_sugar   -0.043809  0.178923  0.110961         0.076492   
resting_ecg            0.345645  0.194595 -0.022225         0.035705   
max_heart_rate         0.244382 -0.368676 -0.181837        -0.337491   
exercise_angina       -0.026119  0.188095  0.194380         0.403428   
oldpeak                0.147227  0.245093  0.096390         0.224106   
st_slope               0.044905  0.237749  0.127913         0.276949   
target                -0.026617  0.262029  0.311267         0.460127   

                     resting_bp_s  cholesterol  fasting_blood_sugar  \
patient_id              -0.002289     0.217898            -0.043809   
age                      0.257692    -0.046472             0.178923   
sex                     -0.006443    -0.208441             0.110961   
chest_pain_type          0.009466    -0.109396             0.076492   
resting_bp_s             1.000000     0.099037             0.088235   
cholesterol              0.099037     1.000000            -0.239778   
fasting_blood_sugar      0.088235    -0.239778             1.000000   
resting_ecg              0.095860     0.150879             0.032124   
max_heart_rate          -0.101357     0.238028            -0.118689   
exercise_angina          0.142435    -0.033261             0.053053   
oldpeak                  0.176111     0.057451             0.031193   
st_slope                 0.089384    -0.100053             0.145902   
target                   0.121415    -0.198366             0.216695   

                     resting_ecg  max_heart_rate  exercise_angina   oldpeak  \
patient_id              0.345645        0.244382        -0.026119  0.147227   
age                     0.194595       -0.368676         0.188095  0.245093   
sex                    -0.022225       -0.181837         0.194380  0.096390   
chest_pain_type         0.035705       -0.337491         0.403428  0.224106   
resting_bp_s            0.095860       -0.101357         0.142435  0.176111   
cholesterol             0.150879        0.238028        -0.033261  0.057451   
fasting_blood_sugar     0.032124       -0.118689         0.053053  0.031193   
resting_ecg             1.000000        0.058812         0.037821  0.126023   
max_heart_rate          0.058812        1.000000        -0.377691 -0.183688   
exercise_angina         0.037821       -0.377691         1.000000  0.370772   
oldpeak                 0.126023       -0.183688         0.370772  1.000000   
st_slope                0.093629       -0.350750         0.393408  0.524639   
target                  0.073059       -0.413278         0.481467  0.398385   

                     st_slope    target  
patient_id           0.044905 -0.026617  
age                  0.237749  0.262029  
sex                  0.127913  0.311267  
chest_pain_type      0.276949  0.460127  
resting_bp_s         0.089384  0.121415  
cholesterol         -0.100053 -0.198366  
fasting_blood_sugar  0.145902  0.216695  
resting_ecg          0.093629  0.073059  
max_heart_rate      -0.350750 -0.413278  
exercise_angina      0.393408  0.481467  
oldpeak              0.524639  0.398385  
st_slope             1.000000  0.505608  
target               0.505608  1.000000  
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Getting alot of issues while pip installing for y profile, hence skipping</span>
<span class="c1">#Had to uninstall anaconda since alot of versions got changed</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Basic statistics</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>        patient_id          age          sex  chest_pain_type  resting_bp_s  \
count  1190.000000  1190.000000  1190.000000      1190.000000   1190.000000   
mean    595.500000    53.720168     0.763866         3.232773    132.153782   
std     343.667717     9.358203     0.424884         0.935480     18.368823   
min       1.000000    28.000000     0.000000         1.000000      0.000000   
25%     298.250000    47.000000     1.000000         3.000000    120.000000   
50%     595.500000    54.000000     1.000000         4.000000    130.000000   
75%     892.750000    60.000000     1.000000         4.000000    140.000000   
max    1190.000000    77.000000     1.000000         4.000000    200.000000   

       cholesterol  fasting_blood_sugar  resting_ecg  max_heart_rate  \
count  1190.000000          1190.000000  1190.000000     1190.000000   
mean    210.363866             0.213445     0.698319      139.732773   
std     101.420489             0.409912     0.870359       25.517636   
min       0.000000             0.000000     0.000000       60.000000   
25%     188.000000             0.000000     0.000000      121.000000   
50%     229.000000             0.000000     0.000000      140.500000   
75%     269.750000             0.000000     2.000000      160.000000   
max     603.000000             1.000000     2.000000      202.000000   

       exercise_angina      oldpeak     st_slope       target  
count      1190.000000  1190.000000  1190.000000  1190.000000  
mean          0.387395     0.922773     1.624370     0.528571  
std           0.487360     1.086337     0.610459     0.499393  
min           0.000000    -2.600000     0.000000     0.000000  
25%           0.000000     0.000000     1.000000     0.000000  
50%           0.000000     0.600000     2.000000     1.000000  
75%           1.000000     1.600000     2.000000     1.000000  
max           1.000000     6.200000     3.000000     1.000000  
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">df</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/fa4cfb1900b82b6fee40fdf580b9d631f05618533ba89a032b238b58f7db81ac.png" src="../_images/fa4cfb1900b82b6fee40fdf580b9d631f05618533ba89a032b238b58f7db81ac.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot histograms for numeric features</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;resting_bp_s&#39;</span><span class="p">,</span> <span class="s1">&#39;cholesterol&#39;</span><span class="p">,</span> <span class="s1">&#39;max_heart_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;oldpeak&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="n">numeric_features</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">layout</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Distribution of Numeric Features&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9c05dca7b3351835efc776a673c7bac44f4b9f4368ac291c329cc19fbc5959ec.png" src="../_images/9c05dca7b3351835efc776a673c7bac44f4b9f4368ac291c329cc19fbc5959ec.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Boxplots for numeric features by target</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_features</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1"> by Target&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/923f43620a522de5e542caa23e03caf66e8ee0a3779901033c1d6d0d9a8dfd80.png" src="../_images/923f43620a522de5e542caa23e03caf66e8ee0a3779901033c1d6d0d9a8dfd80.png" />
<img alt="../_images/b503e601b90b0a13feaecb6ebe655af7092877a8bac883fc37515234969e6a08.png" src="../_images/b503e601b90b0a13feaecb6ebe655af7092877a8bac883fc37515234969e6a08.png" />
<img alt="../_images/5fbaf57a0c16ffb64f44cce5a8c8bb20d932a238b2262dc68c27703c317f72fa.png" src="../_images/5fbaf57a0c16ffb64f44cce5a8c8bb20d932a238b2262dc68c27703c317f72fa.png" />
<img alt="../_images/f6bc5f338c2b62370f8f6dbd97bd3bead8860ef7c85de798a6c5931e3d674ef0.png" src="../_images/f6bc5f338c2b62370f8f6dbd97bd3bead8860ef7c85de798a6c5931e3d674ef0.png" />
<img alt="../_images/12869b52f273e34e5d08c46309ef09a3c5dcedf1e19cafb92ffdac83592e8c57.png" src="../_images/12869b52f273e34e5d08c46309ef09a3c5dcedf1e19cafb92ffdac83592e8c57.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Pair plot</span>
<span class="n">sns</span><span class="o">.</span><span class="n">pairplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="n">diag_kind</span><span class="o">=</span><span class="s1">&#39;kde&#39;</span><span class="p">,</span> <span class="n">corner</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Pair Plot of Features and Target&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e6db036dce6acb1366abf91aba6d09726146497b11d9a4cc45bcc15a9a336156.png" src="../_images/e6db036dce6acb1366abf91aba6d09726146497b11d9a4cc45bcc15a9a336156.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Cat features distribution</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;chest_pain_type&#39;</span><span class="p">,</span> <span class="s1">&#39;fasting_blood_sugar&#39;</span><span class="p">,</span> <span class="s1">&#39;resting_ecg&#39;</span><span class="p">,</span> <span class="s1">&#39;exercise_angina&#39;</span><span class="p">,</span> <span class="s1">&#39;st_slope&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">categorical_features</span><span class="p">:</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1"> Distribution by Target&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Target&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/09b9ec7f67ff2abbebc8ae901803bc336c2c8d0fdcddaada7984d8092f0a5553.png" src="../_images/09b9ec7f67ff2abbebc8ae901803bc336c2c8d0fdcddaada7984d8092f0a5553.png" />
<img alt="../_images/fc804e9e9af4e3af5213dd4bd7ed9890784a804dde3bceb05e2b60ad23852af1.png" src="../_images/fc804e9e9af4e3af5213dd4bd7ed9890784a804dde3bceb05e2b60ad23852af1.png" />
<img alt="../_images/3039aba6dffb00c2c2c3754d849ea2dc739812b5a6e3c074fa91bd1411d898b0.png" src="../_images/3039aba6dffb00c2c2c3754d849ea2dc739812b5a6e3c074fa91bd1411d898b0.png" />
<img alt="../_images/586dec4a806df99f79502dab96625af226bac1225383b3af5f68ad64902033db.png" src="../_images/586dec4a806df99f79502dab96625af226bac1225383b3af5f68ad64902033db.png" />
<img alt="../_images/caa95d71e656d5a9d3d68d7aaa5191c081828719477516b369d45f09a7aa279c.png" src="../_images/caa95d71e656d5a9d3d68d7aaa5191c081828719477516b369d45f09a7aa279c.png" />
<img alt="../_images/828f56224b911d22fe45a9623d8c0a60d9ad7b3a4283cc214860dadfb1546df4.png" src="../_images/828f56224b911d22fe45a9623d8c0a60d9ad7b3a4283cc214860dadfb1546df4.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Boxplots for outlier detection</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_features</span><span class="p">:</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Outlier Detection for </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0847a9124aa3cb0ab4a7cf03833111e97c0409226afc1b67fe8e50a0a1a99846.png" src="../_images/0847a9124aa3cb0ab4a7cf03833111e97c0409226afc1b67fe8e50a0a1a99846.png" />
<img alt="../_images/5dd014ab6b9cefd70a0705031e0d40b51d699f4250e6e0587f083d75ec1de80b.png" src="../_images/5dd014ab6b9cefd70a0705031e0d40b51d699f4250e6e0587f083d75ec1de80b.png" />
<img alt="../_images/fc2db700e28f444552913a009235c0e119d7b81b42f70a4739895930fdae7bf7.png" src="../_images/fc2db700e28f444552913a009235c0e119d7b81b42f70a4739895930fdae7bf7.png" />
<img alt="../_images/259c83275966abf4722631469b6f5a0262c879c031973242cde3790656991edc.png" src="../_images/259c83275966abf4722631469b6f5a0262c879c031973242cde3790656991edc.png" />
<img alt="../_images/1f7ab0eb7007d25ceb30d216915a5c833b44836c0320eb292627e060b26df681.png" src="../_images/1f7ab0eb7007d25ceb30d216915a5c833b44836c0320eb292627e060b26df681.png" />
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="explore-the-data-to-determine-if-you-need-to-stratify-it-by-some-attribute-when-doing-train-test-split-perform-the-train-test-split">
<h1>Explore the data to determine if you need to stratify it by some attribute when doing train/test split. Perform the train/test split.<a class="headerlink" href="#explore-the-data-to-determine-if-you-need-to-stratify-it-by-some-attribute-when-doing-train-test-split-perform-the-train-test-split" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check the distribution of the target variable</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Distribution of target variable:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

<span class="c1"># Visualize the distribution</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">sns</span><span class="o">.</span><span class="n">countplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Distribution of Target Variable&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribution of target variable:
target
1    0.528571
0    0.471429
Name: proportion, dtype: float64
</pre></div>
</div>
<img alt="../_images/a286eff7bdfa31a1ca344a6a02d2784bb7857abb4cf41dc3f65f510b1aaf47b0.png" src="../_images/a286eff7bdfa31a1ca344a6a02d2784bb7857abb4cf41dc3f65f510b1aaf47b0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Distribution of categorical variables</span>
<span class="n">categorical_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;chest_pain_type&#39;</span><span class="p">,</span> <span class="s1">&#39;exercise_angina&#39;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">categorical_columns</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Distribution of </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Distribution of sex:
sex
1    0.763866
0    0.236134
Name: proportion, dtype: float64

Distribution of chest_pain_type:
chest_pain_type
4    0.525210
3    0.237815
2    0.181513
1    0.055462
Name: proportion, dtype: float64

Distribution of exercise_angina:
exercise_angina
0    0.612605
1    0.387395
Name: proportion, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Observations:</p>
<p>Sex:
76% are males (1), while 24% are females (0).
No significant imbalance requiring stratification for this attribute.</p>
<p>Chest_pain_type:
Class 4 (asymptomatic) is the most common (52%), followed by 3 (24%), 2 (18%), and 1 (5%).</p>
<p>Exercise_angina:
Majority (61%) of the data represents individuals without exercise-induced angina (0), while 39% have it (1).
The imbalance is not severe but could be stratified if necessary.</p>
<p>Target:
The target variable is also balanced but we will still stratify to proportionally represnt.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># I have stratified the y (pred) for balance below.</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="experiment-1-create-a-pipeline-for-preprocessing-standardscaler-minmaxscaler-logtransformation-onehotencoding-and-logistic-regression-log-f1-score-tp-tn-fn-fp-in-mlflow-on-dagshub-cross-validation-3-10-folds-resultsmean-std-of-cv-results-and-results-on-the-whole-training-data-add-in-parameter-hyper-tuning">
<h1>Experiment #1: Create a pipeline for preprocessing (StandardScaler, MinMaxScaler, LogTransformation, OneHotEncoding) and Logistic Regression. Log F1-score/(TP,TN,FN,FP)  in MLFlow on DagsHub. – Cross validation 3/10 folds. Results—mean/std of CV results and results on the whole training data – add in parameter hyper tuning<a class="headerlink" href="#experiment-1-create-a-pipeline-for-preprocessing-standardscaler-minmaxscaler-logtransformation-onehotencoding-and-logistic-regression-log-f1-score-tp-tn-fn-fp-in-mlflow-on-dagshub-cross-validation-3-10-folds-resultsmean-std-of-cv-results-and-results-on-the-whole-training-data-add-in-parameter-hyper-tuning" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">pip</span> install -q dagshub mlflow
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Note: you may need to restart the kernel to use updated packages.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dagshub</span>
<span class="n">dagshub</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">repo_owner</span><span class="o">=</span><span class="s1">&#39;rohanjain127&#39;</span><span class="p">,</span> <span class="n">repo_name</span><span class="o">=</span><span class="s1">&#39;my-first-repo&#39;</span><span class="p">,</span> <span class="n">mlflow</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Accessing as rohanjain127
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Initialized MLflow to track repo <span style="color: #008000; text-decoration-color: #008000">"rohanjain127/my-first-repo"</span>
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Repository rohanjain127/my-first-repo initialized!
</pre>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Observation - Need to handle these</span>

<span class="c1"># patient_id: Irrelevant for modeling (acts as an identifier).</span>
<span class="c1"># resting_ecg: Very weak correlation with target</span>
<span class="c1"># Consider dropping one of st_slope or oldpeak due to high inter-correlation (0.524).</span>
<span class="c1"># resting_bp_s values of 0.</span>
<span class="c1"># cholesterol values of 0.</span>
<span class="c1"># oldpeak values below 0.</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">GridSearchCV</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">MinMaxScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span><span class="p">,</span> <span class="n">FunctionTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">confusion_matrix</span>
<span class="kn">import</span> <span class="nn">mlflow</span>

<span class="c1"># Replace 0 values in &#39;resting_bp_s&#39; and &#39;cholesterol&#39; with NaN for imputation</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="c1"># Replace negative values in &#39;oldpeak&#39; with 0</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;oldpeak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;oldpeak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Impute missing values with median</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Drop irrelevant columns</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;patient_id&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Step 2: Preprocessing Pipeline</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;resting_bp_s&#39;</span><span class="p">,</span> <span class="s1">&#39;cholesterol&#39;</span><span class="p">,</span> <span class="s1">&#39;max_heart_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;oldpeak&#39;</span><span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;fasting_blood_sugar&#39;</span><span class="p">,</span> <span class="s1">&#39;exercise_angina&#39;</span><span class="p">,</span> <span class="s1">&#39;chest_pain_type&#39;</span><span class="p">,</span> <span class="s1">&#39;resting_ecg&#39;</span><span class="p">,</span> <span class="s1">&#39;st_slope&#39;</span><span class="p">]</span>

<span class="c1"># Define transformations</span>
<span class="n">log_transformer</span> <span class="o">=</span> <span class="n">FunctionTransformer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">,</span> <span class="n">validate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Log transformation (log(x+1) to handle zeros)</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">minmax_scaler</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>
<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/88/h6q1hd0558n2s59lz2g0xx640000gn/T/ipykernel_95383/3640421178.py:19: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing &#39;df[col].method(value, inplace=True)&#39;, try using &#39;df.method({col: value}, inplace=True)&#39; or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df[&#39;resting_bp_s&#39;].fillna(df[&#39;resting_bp_s&#39;].median(), inplace=True)
/var/folders/88/h6q1hd0558n2s59lz2g0xx640000gn/T/ipykernel_95383/3640421178.py:20: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing &#39;df[col].method(value, inplace=True)&#39;, try using &#39;df.method({col: value}, inplace=True)&#39; or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df[&#39;cholesterol&#39;].fillna(df[&#39;cholesterol&#39;].median(), inplace=True)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>sex</th>
      <th>chest_pain_type</th>
      <th>resting_bp_s</th>
      <th>cholesterol</th>
      <th>fasting_blood_sugar</th>
      <th>resting_ecg</th>
      <th>max_heart_rate</th>
      <th>exercise_angina</th>
      <th>oldpeak</th>
      <th>st_slope</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>40</td>
      <td>1</td>
      <td>2</td>
      <td>140.0</td>
      <td>289.0</td>
      <td>0</td>
      <td>0</td>
      <td>172</td>
      <td>0</td>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>49</td>
      <td>0</td>
      <td>3</td>
      <td>160.0</td>
      <td>180.0</td>
      <td>0</td>
      <td>0</td>
      <td>156</td>
      <td>0</td>
      <td>1.0</td>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>37</td>
      <td>1</td>
      <td>2</td>
      <td>130.0</td>
      <td>283.0</td>
      <td>0</td>
      <td>1</td>
      <td>98</td>
      <td>0</td>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>48</td>
      <td>0</td>
      <td>4</td>
      <td>138.0</td>
      <td>214.0</td>
      <td>0</td>
      <td>0</td>
      <td>108</td>
      <td>1</td>
      <td>1.5</td>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>54</td>
      <td>1</td>
      <td>3</td>
      <td>150.0</td>
      <td>195.0</td>
      <td>0</td>
      <td>0</td>
      <td>122</td>
      <td>0</td>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Combine transformations into preprocessors</span>
<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
    <span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="n">log_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>    <span class="c1"># Apply log transformation</span>
        <span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="n">scaler</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>          <span class="c1"># StandardScaler</span>
        <span class="p">(</span><span class="s1">&#39;minmax&#39;</span><span class="p">,</span> <span class="n">minmax_scaler</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>  <span class="c1"># MinMaxScaler</span>
        <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Apply preprocessing to the entire dataset before splitting</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

<span class="c1"># Get transformed column names</span>
<span class="n">encoded_columns</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s1">&#39;cat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)</span>
<span class="n">all_columns</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">[</span><span class="s2">&quot;log_&quot;</span> <span class="o">+</span> <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_features</span><span class="p">]</span> <span class="o">+</span>
    <span class="p">[</span><span class="s2">&quot;scale_&quot;</span> <span class="o">+</span> <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_features</span><span class="p">]</span> <span class="o">+</span>
    <span class="p">[</span><span class="s2">&quot;minmax_&quot;</span> <span class="o">+</span> <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_features</span><span class="p">]</span> <span class="o">+</span>
    <span class="nb">list</span><span class="p">(</span><span class="n">encoded_columns</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">all_columns</span><span class="p">)</span>

<span class="c1"># Step 3: Train-Test Split</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>log_age</th>
      <th>log_resting_bp_s</th>
      <th>log_cholesterol</th>
      <th>log_max_heart_rate</th>
      <th>log_oldpeak</th>
      <th>scale_age</th>
      <th>scale_resting_bp_s</th>
      <th>scale_cholesterol</th>
      <th>scale_max_heart_rate</th>
      <th>scale_oldpeak</th>
      <th>...</th>
      <th>fasting_blood_sugar_1</th>
      <th>exercise_angina_1</th>
      <th>chest_pain_type_2</th>
      <th>chest_pain_type_3</th>
      <th>chest_pain_type_4</th>
      <th>resting_ecg_1</th>
      <th>resting_ecg_2</th>
      <th>st_slope_1</th>
      <th>st_slope_2</th>
      <th>st_slope_3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>360</th>
      <td>3.988984</td>
      <td>4.663439</td>
      <td>5.484797</td>
      <td>4.753590</td>
      <td>0.000000</td>
      <td>-0.076988</td>
      <td>-1.518258</td>
      <td>-0.095409</td>
      <td>-0.969650</td>
      <td>-0.873002</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>842</th>
      <td>3.737670</td>
      <td>4.912655</td>
      <td>5.318120</td>
      <td>4.890349</td>
      <td>0.000000</td>
      <td>-1.359825</td>
      <td>0.152420</td>
      <td>-0.794037</td>
      <td>-0.303164</td>
      <td>-0.873002</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>54</th>
      <td>3.970292</td>
      <td>4.875197</td>
      <td>5.198497</td>
      <td>4.948760</td>
      <td>0.916291</td>
      <td>-0.183891</td>
      <td>-0.126026</td>
      <td>-1.228319</td>
      <td>0.010477</td>
      <td>0.529742</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>528</th>
      <td>4.127134</td>
      <td>4.941642</td>
      <td>5.648974</td>
      <td>4.912655</td>
      <td>0.262364</td>
      <td>0.778236</td>
      <td>0.375177</td>
      <td>0.716510</td>
      <td>-0.185549</td>
      <td>-0.592453</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>969</th>
      <td>3.688879</td>
      <td>4.948760</td>
      <td>5.774552</td>
      <td>5.209486</td>
      <td>0.000000</td>
      <td>-1.573631</td>
      <td>0.430866</td>
      <td>1.434020</td>
      <td>1.657089</td>
      <td>-0.873002</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 26 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>360    1
842    0
54     0
528    0
969    0
Name: target, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Step 4: Pipeline with Logistic Regression</span>
<span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;classifier&#39;</span><span class="p">,</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">))</span>
<span class="p">])</span>

<span class="c1"># Step 5: Hyperparameter Tuning and Cross-Validation</span>
<span class="n">param_grid</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;classifier__C&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
    <span class="s1">&#39;classifier__penalty&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="s1">&#39;l2&#39;</span><span class="p">],</span>
    <span class="s1">&#39;classifier__solver&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;liblinear&#39;</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Option for 3-Fold Cross-Validation</span>
<span class="n">cv_3fold</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">cv_10fold</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Choose CV folds dynamically (change `cv` as needed)</span>
<span class="n">cv</span> <span class="o">=</span> <span class="n">cv_10fold</span>  <span class="c1"># Change to cv_3fold for 3-fold CV</span>

<span class="n">grid_search</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="n">param_grid</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Fit the model</span>
<span class="n">grid_search</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Best model and parameters</span>
<span class="n">best_model</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_estimator_</span>
<span class="n">best_params</span> <span class="o">=</span> <span class="n">grid_search</span><span class="o">.</span><span class="n">best_params_</span>

<span class="c1"># Evaluate on Training Data</span>
<span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">f1_train</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
<span class="n">cm_train</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
<span class="n">tn_train</span><span class="p">,</span> <span class="n">fp_train</span><span class="p">,</span> <span class="n">fn_train</span><span class="p">,</span> <span class="n">tp_train</span> <span class="o">=</span> <span class="n">cm_train</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="c1"># Evaluate on Test Data</span>
<span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">f1_test</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="n">cm_test</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="n">tn_test</span><span class="p">,</span> <span class="n">fp_test</span><span class="p">,</span> <span class="n">fn_test</span><span class="p">,</span> <span class="n">tp_test</span> <span class="o">=</span> <span class="n">cm_test</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="c1"># Step 6: Log Results in MLFlow</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="s2">&quot;https://dagshub.com/rohanjain127/my-first-repo.mlflow&quot;</span><span class="p">)</span>  <span class="c1"># Replace with your DagsHub details</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;Heart Disease Experiment&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="s2">&quot;LogisticRegression1st&quot;</span><span class="p">):</span>
    <span class="c1"># Log best parameters and metrics</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_params</span><span class="p">(</span><span class="n">best_params</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Train F1 Score&quot;</span><span class="p">,</span> <span class="n">f1_train</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Test F1 Score&quot;</span><span class="p">,</span> <span class="n">f1_test</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Train True Positives&quot;</span><span class="p">,</span> <span class="n">tp_train</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Train True Negatives&quot;</span><span class="p">,</span> <span class="n">tn_train</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Train False Positives&quot;</span><span class="p">,</span> <span class="n">fp_train</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Train False Negatives&quot;</span><span class="p">,</span> <span class="n">fn_train</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Test True Positives&quot;</span><span class="p">,</span> <span class="n">tp_test</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Test True Negatives&quot;</span><span class="p">,</span> <span class="n">tn_test</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Test False Positives&quot;</span><span class="p">,</span> <span class="n">fp_test</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Test False Negatives&quot;</span><span class="p">,</span> <span class="n">fn_test</span><span class="p">)</span>

    <span class="c1"># Log model</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="s2">&quot;Logistic Regression Model&quot;</span><span class="p">)</span>

<span class="c1"># Print Results</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Model Parameters ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Best Parameters:&quot;</span><span class="p">,</span> <span class="n">best_params</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Training Metrics ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training F1 Score: </span><span class="si">{</span><span class="n">f1_train</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training Confusion Matrix: TP=</span><span class="si">{</span><span class="n">tp_train</span><span class="si">}</span><span class="s2">, TN=</span><span class="si">{</span><span class="n">tn_train</span><span class="si">}</span><span class="s2">, FP=</span><span class="si">{</span><span class="n">fp_train</span><span class="si">}</span><span class="s2">, FN=</span><span class="si">{</span><span class="n">fn_train</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Test Metrics ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test F1 Score: </span><span class="si">{</span><span class="n">f1_test</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test Confusion Matrix: TP=</span><span class="si">{</span><span class="n">tp_test</span><span class="si">}</span><span class="s2">, TN=</span><span class="si">{</span><span class="n">tn_test</span><span class="si">}</span><span class="s2">, FP=</span><span class="si">{</span><span class="n">fp_test</span><span class="si">}</span><span class="s2">, FN=</span><span class="si">{</span><span class="n">fn_test</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Red">2024/12/21 18:30:52 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run LogisticRegression1st at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/01d43f5e5a8f45e8aacee093b31b0de1
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1

=== Model Parameters ===
Best Parameters: {&#39;classifier__C&#39;: 1, &#39;classifier__penalty&#39;: &#39;l2&#39;, &#39;classifier__solver&#39;: &#39;liblinear&#39;}

=== Training Metrics ===
Training F1 Score: 0.8652900688298918
Training Confusion Matrix: TP=440, TN=375, FP=74, FN=63

=== Test Metrics ===
Test F1 Score: 0.8682170542635659
Test Confusion Matrix: TP=112, TN=92, FP=20, FN=14
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="experiment-2-create-a-pipeline-for-preprocessing-and-use-logisticregression-ridgeclassifier-randomforestclassifier-and-xgbclassifier-log-results-in-mlflow-on-dagshub">
<h1>Experiment #2: Create a pipeline for preprocessing and use LogisticRegression, RidgeClassifier, RandomForestClassifier, and XGBClassifier. Log results in MLFlow on DagsHub.<a class="headerlink" href="#experiment-2-create-a-pipeline-for-preprocessing-and-use-logisticregression-ridgeclassifier-randomforestclassifier-and-xgbclassifier-log-results-in-mlflow-on-dagshub" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>xgboost
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Requirement already satisfied: xgboost in /opt/anaconda3/lib/python3.12/site-packages (2.1.3)
Requirement already satisfied: numpy in /opt/anaconda3/lib/python3.12/site-packages (from xgboost) (1.26.4)
Requirement already satisfied: scipy in /opt/anaconda3/lib/python3.12/site-packages (from xgboost) (1.13.1)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xgboost</span>
<span class="nb">print</span><span class="p">(</span><span class="n">xgboost</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2.1.3
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">StratifiedKFold</span><span class="p">,</span> <span class="n">cross_val_score</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span><span class="p">,</span> <span class="n">RidgeClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">confusion_matrix</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">mlflow.sklearn</span>
<span class="kn">import</span> <span class="nn">mlflow.xgboost</span>
<span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;xgboost&#39;</span><span class="p">)</span>

<span class="c1"># Step 4: Classifiers to Test</span>
<span class="n">classifiers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;LogisticRegression2nd&quot;</span><span class="p">:</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="s2">&quot;RidgeClassifier1st&quot;</span><span class="p">:</span> <span class="n">RidgeClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="s2">&quot;RandomForestClassifier1st&quot;</span><span class="p">:</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="s2">&quot;XGBClassifier1st&quot;</span><span class="p">:</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Store trained models separately</span>
<span class="n">trained_models</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="s2">&quot;https://dagshub.com/rohanjain127/my-first-repo.mlflow&quot;</span><span class="p">)</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;Heart Disease Experiment&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">clf</span> <span class="ow">in</span> <span class="n">classifiers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

    <span class="c1"># Cross-validation</span>
    <span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">f1_scores</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;f1&#39;</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Fit on training data</span>
    <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

    <span class="c1"># Save trained model to the new dictionary</span>
    <span class="n">trained_models</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">clf</span>  <span class="c1"># Avoid overwriting the original &#39;classifiers&#39; dictionary</span>

    <span class="c1"># Predictions</span>
    <span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
    <span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># Metrics</span>
    <span class="n">f1_train</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">f1_test</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
    <span class="n">cm_train</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">cm_test</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>

    <span class="c1"># Log to MLFlow</span>
    <span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="n">name</span><span class="p">):</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">&quot;Classifier&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Train F1 Score&quot;</span><span class="p">,</span> <span class="n">f1_train</span><span class="p">)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Test F1 Score&quot;</span><span class="p">,</span> <span class="n">f1_test</span><span class="p">)</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;CV F1 Score Mean&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">f1_scores</span><span class="p">))</span>
        <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;CV F1 Score Std&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">f1_scores</span><span class="p">))</span>

        <span class="c1"># Log the model</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;XGBClassifier1st&quot;</span><span class="p">:</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">xgboost</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">clf</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train F1 Score: </span><span class="si">{</span><span class="n">f1_train</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test F1 Score: </span><span class="si">{</span><span class="n">f1_test</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CV F1 Score Mean: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">f1_scores</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CV F1 Score Std: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">f1_scores</span><span class="p">)</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1"># Step 6: Select and Save the Best Model</span>
<span class="n">best_model</span> <span class="o">=</span> <span class="n">trained_models</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XGBClassifier1st&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Use .get() to avoid KeyError</span>

<span class="k">if</span> <span class="n">best_model</span><span class="p">:</span>
    <span class="n">model_path</span> <span class="o">=</span> <span class="s1">&#39;/Users/rohanjain/Desktop/Sem1/Prog_DB/Final_project/heart_disease_best_model.joblib&#39;</span>
    <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Best Model (XGBClassifier1st) saved to: </span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;XGBClassifier1st not found in trained models.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Running LogisticRegression2nd...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Red">2024/12/21 18:31:04 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run LogisticRegression2nd at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/64e3aaba1c954e0fa44d4ba035a08710
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1
LogisticRegression2nd:
Train F1 Score: 0.8652900688298918
Test F1 Score: 0.8682170542635659
CV F1 Score Mean: 0.8629
CV F1 Score Std: 0.0372

Running RidgeClassifier1st...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Red">2024/12/21 18:31:19 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run RidgeClassifier1st at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/ccc63abe974f4420b6d118d0b6537bee
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1
RidgeClassifier1st:
Train F1 Score: 0.8630541871921182
Test F1 Score: 0.8715953307392996
CV F1 Score Mean: 0.8533
CV F1 Score Std: 0.0311

Running RandomForestClassifier1st...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Red">2024/12/21 18:31:34 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run RandomForestClassifier1st at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/341812e9f3ee44aa8b4cc3734f4a41db
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1
RandomForestClassifier1st:
Train F1 Score: 1.0
Test F1 Score: 0.9236947791164659
CV F1 Score Mean: 0.9178
CV F1 Score Std: 0.0192

Running XGBClassifier1st...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/opt/anaconda3/lib/python3.12/site-packages/xgboost/core.py:158: UserWarning: [18:31:42] WARNING: /Users/runner/work/xgboost/xgboost/src/learner.cc:740: 
Parameters: { &quot;use_label_encoder&quot; } are not used.

  warnings.warn(smsg, UserWarning)
/opt/anaconda3/lib/python3.12/site-packages/xgboost/core.py:158: UserWarning: [18:31:42] WARNING: /Users/runner/work/xgboost/xgboost/src/learner.cc:740: 
Parameters: { &quot;use_label_encoder&quot; } are not used.

  warnings.warn(smsg, UserWarning)
/opt/anaconda3/lib/python3.12/site-packages/xgboost/core.py:158: UserWarning: [18:31:42] WARNING: /Users/runner/work/xgboost/xgboost/src/learner.cc:740: 
Parameters: { &quot;use_label_encoder&quot; } are not used.

  warnings.warn(smsg, UserWarning)
/opt/anaconda3/lib/python3.12/site-packages/xgboost/core.py:158: UserWarning: [18:31:42] WARNING: /Users/runner/work/xgboost/xgboost/src/learner.cc:740: 
Parameters: { &quot;use_label_encoder&quot; } are not used.

  warnings.warn(smsg, UserWarning)
/opt/anaconda3/lib/python3.12/site-packages/xgboost/core.py:158: UserWarning: [18:31:42] WARNING: /Users/runner/work/xgboost/xgboost/src/learner.cc:740: 
Parameters: { &quot;use_label_encoder&quot; } are not used.

  warnings.warn(smsg, UserWarning)
/opt/anaconda3/lib/python3.12/site-packages/xgboost/core.py:158: UserWarning: [18:31:42] WARNING: /Users/runner/work/xgboost/xgboost/src/learner.cc:740: 
Parameters: { &quot;use_label_encoder&quot; } are not used.

  warnings.warn(smsg, UserWarning)
/opt/anaconda3/lib/python3.12/site-packages/xgboost/core.py:158: UserWarning: [18:31:42] WARNING: /Users/runner/work/xgboost/xgboost/src/learner.cc:740: 
Parameters: { &quot;use_label_encoder&quot; } are not used.

  warnings.warn(smsg, UserWarning)
/opt/anaconda3/lib/python3.12/site-packages/xgboost/core.py:158: UserWarning: [18:31:42] WARNING: /Users/runner/work/xgboost/xgboost/src/learner.cc:740: 
Parameters: { &quot;use_label_encoder&quot; } are not used.

  warnings.warn(smsg, UserWarning)
/opt/anaconda3/lib/python3.12/site-packages/xgboost/core.py:158: UserWarning: [18:31:42] WARNING: /Users/runner/work/xgboost/xgboost/src/learner.cc:740: 
Parameters: { &quot;use_label_encoder&quot; } are not used.

  warnings.warn(smsg, UserWarning)
/opt/anaconda3/lib/python3.12/site-packages/xgboost/core.py:158: UserWarning: [18:31:42] WARNING: /Users/runner/work/xgboost/xgboost/src/learner.cc:740: 
Parameters: { &quot;use_label_encoder&quot; } are not used.

  warnings.warn(smsg, UserWarning)
<span class=" -Color -Color-Red">2024/12/21 18:31:49 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run XGBClassifier1st at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/3e374e875f684e75b6bbecdad8fe081d
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1
XGBClassifier1st:
Train F1 Score: 1.0
Test F1 Score: 0.9444444444444444
CV F1 Score Mean: 0.9306
CV F1 Score Std: 0.0226

Best Model (XGBClassifier1st) saved to: /Users/rohanjain/Desktop/Sem1/Prog_DB/Final_project/heart_disease_best_model.joblib
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>log_age</th>
      <th>log_resting_bp_s</th>
      <th>log_cholesterol</th>
      <th>log_max_heart_rate</th>
      <th>log_oldpeak</th>
      <th>scale_age</th>
      <th>scale_resting_bp_s</th>
      <th>scale_cholesterol</th>
      <th>scale_max_heart_rate</th>
      <th>scale_oldpeak</th>
      <th>...</th>
      <th>fasting_blood_sugar_1</th>
      <th>exercise_angina_1</th>
      <th>chest_pain_type_2</th>
      <th>chest_pain_type_3</th>
      <th>chest_pain_type_4</th>
      <th>resting_ecg_1</th>
      <th>resting_ecg_2</th>
      <th>st_slope_1</th>
      <th>st_slope_2</th>
      <th>st_slope_3</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>360</th>
      <td>3.988984</td>
      <td>4.663439</td>
      <td>5.484797</td>
      <td>4.753590</td>
      <td>0.000000</td>
      <td>-0.076988</td>
      <td>-1.518258</td>
      <td>-0.095409</td>
      <td>-0.969650</td>
      <td>-0.873002</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>842</th>
      <td>3.737670</td>
      <td>4.912655</td>
      <td>5.318120</td>
      <td>4.890349</td>
      <td>0.000000</td>
      <td>-1.359825</td>
      <td>0.152420</td>
      <td>-0.794037</td>
      <td>-0.303164</td>
      <td>-0.873002</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>54</th>
      <td>3.970292</td>
      <td>4.875197</td>
      <td>5.198497</td>
      <td>4.948760</td>
      <td>0.916291</td>
      <td>-0.183891</td>
      <td>-0.126026</td>
      <td>-1.228319</td>
      <td>0.010477</td>
      <td>0.529742</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>528</th>
      <td>4.127134</td>
      <td>4.941642</td>
      <td>5.648974</td>
      <td>4.912655</td>
      <td>0.262364</td>
      <td>0.778236</td>
      <td>0.375177</td>
      <td>0.716510</td>
      <td>-0.185549</td>
      <td>-0.592453</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>969</th>
      <td>3.688879</td>
      <td>4.948760</td>
      <td>5.774552</td>
      <td>5.209486</td>
      <td>0.000000</td>
      <td>-1.573631</td>
      <td>0.430866</td>
      <td>1.434020</td>
      <td>1.657089</td>
      <td>-0.873002</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 26 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get all column names after preprocessing</span>
<span class="n">XGBClassifier1st_column_names</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># Print the column names</span>
<span class="nb">print</span><span class="p">(</span><span class="n">XGBClassifier1st_column_names</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;log_age&#39;, &#39;log_resting_bp_s&#39;, &#39;log_cholesterol&#39;, &#39;log_max_heart_rate&#39;, &#39;log_oldpeak&#39;, &#39;scale_age&#39;, &#39;scale_resting_bp_s&#39;, &#39;scale_cholesterol&#39;, &#39;scale_max_heart_rate&#39;, &#39;scale_oldpeak&#39;, &#39;minmax_age&#39;, &#39;minmax_resting_bp_s&#39;, &#39;minmax_cholesterol&#39;, &#39;minmax_max_heart_rate&#39;, &#39;minmax_oldpeak&#39;, &#39;sex_1&#39;, &#39;fasting_blood_sugar_1&#39;, &#39;exercise_angina_1&#39;, &#39;chest_pain_type_2&#39;, &#39;chest_pain_type_3&#39;, &#39;chest_pain_type_4&#39;, &#39;resting_ecg_1&#39;, &#39;resting_ecg_2&#39;, &#39;st_slope_1&#39;, &#39;st_slope_2&#39;, &#39;st_slope_3&#39;]
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="experiment-3-perform-feature-engineering-and-attribute-combination-log-results-in-mlflow">
<h1>Experiment #3: Perform feature engineering and attribute combination. Log results in MLFlow.<a class="headerlink" href="#experiment-3-perform-feature-engineering-and-attribute-combination-log-results-in-mlflow" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df_combined</span>
<span class="k">def</span> <span class="nf">clean_column_names</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">clean_column_names</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>patient_id</th>
      <th>age</th>
      <th>sex</th>
      <th>chest_pain_type</th>
      <th>resting_bp_s</th>
      <th>cholesterol</th>
      <th>fasting_blood_sugar</th>
      <th>resting_ecg</th>
      <th>max_heart_rate</th>
      <th>exercise_angina</th>
      <th>oldpeak</th>
      <th>st_slope</th>
      <th>target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>40</td>
      <td>1</td>
      <td>2</td>
      <td>140.0</td>
      <td>289.0</td>
      <td>0</td>
      <td>0</td>
      <td>172</td>
      <td>0</td>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>49</td>
      <td>0</td>
      <td>3</td>
      <td>160.0</td>
      <td>180.0</td>
      <td>0</td>
      <td>0</td>
      <td>156</td>
      <td>0</td>
      <td>1.0</td>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>37</td>
      <td>1</td>
      <td>2</td>
      <td>130.0</td>
      <td>283.0</td>
      <td>0</td>
      <td>1</td>
      <td>98</td>
      <td>0</td>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>48</td>
      <td>0</td>
      <td>4</td>
      <td>138.0</td>
      <td>214.0</td>
      <td>0</td>
      <td>0</td>
      <td>108</td>
      <td>1</td>
      <td>1.5</td>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>54</td>
      <td>1</td>
      <td>3</td>
      <td>150.0</td>
      <td>195.0</td>
      <td>0</td>
      <td>0</td>
      <td>122</td>
      <td>0</td>
      <td>0.0</td>
      <td>1</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Step 1: Data Cleaning (Reused from previous experiments)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;oldpeak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;oldpeak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;patient_id&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Step 2: Feature Engineering</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;bp_cholesterol_interaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;age_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Young&#39;</span><span class="p">,</span> <span class="s1">&#39;Middle-aged&#39;</span><span class="p">,</span> <span class="s1">&#39;Senior&#39;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol_squared&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;bp_hr_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;max_heart_rate&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;combined_health_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">,</span> <span class="s1">&#39;cholesterol&#39;</span><span class="p">,</span> <span class="s1">&#39;max_heart_rate&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Step 3: Preprocessing</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;resting_bp_s&#39;</span><span class="p">,</span> <span class="s1">&#39;cholesterol&#39;</span><span class="p">,</span> <span class="s1">&#39;max_heart_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;oldpeak&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;bp_cholesterol_interaction&#39;</span><span class="p">,</span> <span class="s1">&#39;cholesterol_squared&#39;</span><span class="p">,</span> <span class="s1">&#39;bp_hr_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;combined_health_score&#39;</span><span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;fasting_blood_sugar&#39;</span><span class="p">,</span> <span class="s1">&#39;exercise_angina&#39;</span><span class="p">,</span> <span class="s1">&#39;chest_pain_type&#39;</span><span class="p">,</span> <span class="s1">&#39;resting_ecg&#39;</span><span class="p">,</span> <span class="s1">&#39;st_slope&#39;</span><span class="p">,</span> <span class="s1">&#39;age_group&#39;</span><span class="p">]</span>

<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
    <span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Apply preprocessing to the entire dataset and convert back to DataFrame</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]))</span>

<span class="c1"># Retrieve column names after transformation</span>
<span class="n">encoded_columns</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s1">&#39;cat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)</span>
<span class="n">all_columns</span> <span class="o">=</span> <span class="n">numeric_features</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">encoded_columns</span><span class="p">)</span>

<span class="c1"># Convert to DataFrame with appropriate column names</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">all_columns</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

<span class="c1"># Step 4: Train-Test Split</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># Step 5: Logistic Regression (Example Model)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Predictions</span>
<span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Metrics</span>
<span class="n">f1_train</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
<span class="n">f1_test</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="n">cm_train</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
<span class="n">cm_test</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="n">tn_train</span><span class="p">,</span> <span class="n">fp_train</span><span class="p">,</span> <span class="n">fn_train</span><span class="p">,</span> <span class="n">tp_train</span> <span class="o">=</span> <span class="n">cm_train</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">tn_test</span><span class="p">,</span> <span class="n">fp_test</span><span class="p">,</span> <span class="n">fn_test</span><span class="p">,</span> <span class="n">tp_test</span> <span class="o">=</span> <span class="n">cm_test</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="c1"># Step 6: Log Results in MLFlow</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="s2">&quot;https://dagshub.com/rohanjain127/my-first-repo.mlflow&quot;</span><span class="p">)</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;Heart Disease Experiment&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="s2">&quot;LogisticRegression_FE&quot;</span><span class="p">):</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Train F1 Score&quot;</span><span class="p">,</span> <span class="n">f1_train</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Test F1 Score&quot;</span><span class="p">,</span> <span class="n">f1_test</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Train True Positives&quot;</span><span class="p">,</span> <span class="n">cm_train</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Train True Negatives&quot;</span><span class="p">,</span> <span class="n">cm_train</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Train False Positives&quot;</span><span class="p">,</span> <span class="n">cm_train</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Train False Negatives&quot;</span><span class="p">,</span> <span class="n">cm_train</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Test True Positives&quot;</span><span class="p">,</span> <span class="n">cm_test</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Test True Negatives&quot;</span><span class="p">,</span> <span class="n">cm_test</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Test False Positives&quot;</span><span class="p">,</span> <span class="n">cm_test</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Test False Negatives&quot;</span><span class="p">,</span> <span class="n">cm_test</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    
    <span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;LR with Feature Engineering&quot;</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">&quot;Features&quot;</span><span class="p">,</span> <span class="n">all_columns</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Feature Engineering Experiment completed and logged in MLFlow.&quot;</span><span class="p">)</span>

<span class="c1"># Print results</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Feature Engineering Results ---&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train F1 Score: </span><span class="si">{</span><span class="n">f1_train</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test F1 Score: </span><span class="si">{</span><span class="n">f1_test</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training Confusion Matrix:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TP: </span><span class="si">{</span><span class="n">tp_train</span><span class="si">}</span><span class="s2">, TN: </span><span class="si">{</span><span class="n">tn_train</span><span class="si">}</span><span class="s2">, FP: </span><span class="si">{</span><span class="n">fp_train</span><span class="si">}</span><span class="s2">, FN: </span><span class="si">{</span><span class="n">fn_train</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Test Confusion Matrix:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TP: </span><span class="si">{</span><span class="n">tp_test</span><span class="si">}</span><span class="s2">, TN: </span><span class="si">{</span><span class="n">tn_test</span><span class="si">}</span><span class="s2">, FP: </span><span class="si">{</span><span class="n">fp_test</span><span class="si">}</span><span class="s2">, FN: </span><span class="si">{</span><span class="n">fn_test</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/88/h6q1hd0558n2s59lz2g0xx640000gn/T/ipykernel_95383/4116694033.py:5: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing &#39;df[col].method(value, inplace=True)&#39;, try using &#39;df.method({col: value}, inplace=True)&#39; or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df[&#39;resting_bp_s&#39;].fillna(df[&#39;resting_bp_s&#39;].median(), inplace=True)
/var/folders/88/h6q1hd0558n2s59lz2g0xx640000gn/T/ipykernel_95383/4116694033.py:6: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing &#39;df[col].method(value, inplace=True)&#39;, try using &#39;df.method({col: value}, inplace=True)&#39; or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df[&#39;cholesterol&#39;].fillna(df[&#39;cholesterol&#39;].median(), inplace=True)
<span class=" -Color -Color-Red">2024/12/21 18:32:09 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run LogisticRegression_FE at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/167436c2793543f295aee21f24c29e9a
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1
Feature Engineering Experiment completed and logged in MLFlow.

--- Feature Engineering Results ---
Train F1 Score: 0.8644400785854617
Test F1 Score: 0.875

Training Confusion Matrix:
TP: 440, TN: 374, FP: 75, FN: 63

Test Confusion Matrix:
TP: 112, TN: 94, FP: 18, FN: 14
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>resting_bp_s</th>
      <th>cholesterol</th>
      <th>max_heart_rate</th>
      <th>oldpeak</th>
      <th>bp_cholesterol_interaction</th>
      <th>cholesterol_squared</th>
      <th>bp_hr_ratio</th>
      <th>combined_health_score</th>
      <th>sex_1</th>
      <th>...</th>
      <th>chest_pain_type_2</th>
      <th>chest_pain_type_3</th>
      <th>chest_pain_type_4</th>
      <th>resting_ecg_1</th>
      <th>resting_ecg_2</th>
      <th>st_slope_1</th>
      <th>st_slope_2</th>
      <th>st_slope_3</th>
      <th>age_group_Senior</th>
      <th>age_group_Young</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>360</th>
      <td>-0.076988</td>
      <td>-1.518258</td>
      <td>-0.095409</td>
      <td>-0.969650</td>
      <td>-0.873002</td>
      <td>-0.834938</td>
      <td>-0.171930</td>
      <td>-0.276076</td>
      <td>-0.915600</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>842</th>
      <td>-1.359825</td>
      <td>0.152420</td>
      <td>-0.794037</td>
      <td>-0.303164</td>
      <td>-0.873002</td>
      <td>-0.583067</td>
      <td>-0.708119</td>
      <td>0.140063</td>
      <td>-0.755106</td>
      <td>1.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>54</th>
      <td>-0.183891</td>
      <td>-0.126026</td>
      <td>-1.228319</td>
      <td>0.010477</td>
      <td>0.529742</td>
      <td>-1.040548</td>
      <td>-0.996283</td>
      <td>-0.217163</td>
      <td>-1.076095</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>528</th>
      <td>0.778236</td>
      <td>0.375177</td>
      <td>0.716510</td>
      <td>-0.185549</td>
      <td>-0.592453</td>
      <td>0.779895</td>
      <td>0.563739</td>
      <td>0.166251</td>
      <td>0.641195</td>
      <td>1.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>969</th>
      <td>-1.573631</td>
      <td>0.430866</td>
      <td>1.434020</td>
      <td>1.657089</td>
      <td>-0.873002</td>
      <td>1.419912</td>
      <td>1.314555</td>
      <td>-0.821699</td>
      <td>2.021448</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 22 columns</p>
</div></div></div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="experiment-4-perform-feature-selection-using-correlation-threshold-feature-importance-and-variance-threshold-log-results-in-mlflow">
<h1>Experiment #4: Perform feature selection using Correlation Threshold, Feature Importance, and Variance Threshold. Log results in MLFlow.<a class="headerlink" href="#experiment-4-perform-feature-selection-using-correlation-threshold-feature-importance-and-variance-threshold-log-results-in-mlflow" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_selection</span> <span class="kn">import</span> <span class="n">VarianceThreshold</span><span class="p">,</span> <span class="n">SelectFromModel</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">confusion_matrix</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Step 1: Reload and Clean Data (from df_combined)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df_combined</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">clean_column_names</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">clean_column_names</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># Data Cleaning</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;oldpeak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;oldpeak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;patient_id&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># Step 2: Feature Engineering</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;bp_cholesterol_interaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;age_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Young&#39;</span><span class="p">,</span> <span class="s1">&#39;Middle-aged&#39;</span><span class="p">,</span> <span class="s1">&#39;Senior&#39;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol_squared&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;bp_hr_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;max_heart_rate&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;combined_health_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">,</span> <span class="s1">&#39;cholesterol&#39;</span><span class="p">,</span> <span class="s1">&#39;max_heart_rate&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Feature List</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;resting_bp_s&#39;</span><span class="p">,</span> <span class="s1">&#39;cholesterol&#39;</span><span class="p">,</span> <span class="s1">&#39;max_heart_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;oldpeak&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;bp_cholesterol_interaction&#39;</span><span class="p">,</span> <span class="s1">&#39;cholesterol_squared&#39;</span><span class="p">,</span> <span class="s1">&#39;bp_hr_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;combined_health_score&#39;</span><span class="p">]</span>

<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;fasting_blood_sugar&#39;</span><span class="p">,</span> <span class="s1">&#39;exercise_angina&#39;</span><span class="p">,</span> 
                        <span class="s1">&#39;chest_pain_type&#39;</span><span class="p">,</span> <span class="s1">&#39;resting_ecg&#39;</span><span class="p">,</span> <span class="s1">&#39;st_slope&#39;</span><span class="p">,</span> <span class="s1">&#39;age_group&#39;</span><span class="p">]</span>

<span class="c1"># Preprocessing: Scaling + Encoding</span>
<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
    <span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Apply preprocessing</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

<span class="c1"># Extract updated feature names</span>
<span class="n">encoded_columns</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s1">&#39;cat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)</span>
<span class="n">all_columns</span> <span class="o">=</span> <span class="n">numeric_features</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">encoded_columns</span><span class="p">)</span>

<span class="c1"># Convert to DataFrame</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">all_columns</span><span class="p">)</span>

<span class="c1"># Step 4: Train-Test Split</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># Print initial shape and feature names</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial Train Data Shape: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial Features: </span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Step 5: Feature Selection</span>
<span class="c1">## 1. Variance Threshold</span>
<span class="n">variance_thresh</span> <span class="o">=</span> <span class="n">VarianceThreshold</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">X_train_var</span> <span class="o">=</span> <span class="n">variance_thresh</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_var</span> <span class="o">=</span> <span class="n">variance_thresh</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Identify kept and dropped features</span>
<span class="n">kept_features_var</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">variance_thresh</span><span class="o">.</span><span class="n">get_support</span><span class="p">()]</span>
<span class="n">dropped_features_var</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">kept_features_var</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Features Kept After Variance Threshold: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">kept_features_var</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Features Dropped After Variance Threshold: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">dropped_features_var</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After Variance Threshold: </span><span class="si">{</span><span class="n">X_train_var</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1">## 2. Correlation Threshold</span>
<span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train_var</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">kept_features_var</span><span class="p">)</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
<span class="n">upper</span> <span class="o">=</span> <span class="n">corr_matrix</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">corr_matrix</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>
<span class="n">to_drop_corr</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">upper</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">upper</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.8</span><span class="p">)]</span>

<span class="n">X_train_corr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train_var</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">kept_features_var</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">to_drop_corr</span><span class="p">)</span>
<span class="n">X_test_corr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test_var</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">kept_features_var</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">to_drop_corr</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Features Dropped Due to High Correlation: </span><span class="si">{</span><span class="n">to_drop_corr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Features Kept After Correlation Threshold: </span><span class="si">{</span><span class="n">X_train_corr</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;After Correlation Threshold: </span><span class="si">{</span><span class="n">X_train_corr</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1">## 3. Feature Importance (Random Forest)</span>
<span class="n">selector</span> <span class="o">=</span> <span class="n">SelectFromModel</span><span class="p">(</span><span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span> <span class="n">threshold</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span>
<span class="n">X_train_selected</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_corr</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">X_test_selected</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_corr</span><span class="p">)</span>

<span class="c1"># Convert to DataFrame for consistency</span>
<span class="n">X_train_selected</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train_selected</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">X_train_corr</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">selector</span><span class="o">.</span><span class="n">get_support</span><span class="p">()])</span>
<span class="n">X_test_selected</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test_selected</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">X_train_corr</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">selector</span><span class="o">.</span><span class="n">get_support</span><span class="p">()])</span>

<span class="c1"># Selected Features</span>
<span class="n">selected_features</span> <span class="o">=</span> <span class="n">X_train_corr</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">selector</span><span class="o">.</span><span class="n">get_support</span><span class="p">()]</span>
<span class="n">dropped_features_rf</span> <span class="o">=</span> <span class="n">X_train_corr</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">selected_features</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Selected Features by Random Forest: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">selected_features</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Features Dropped by Random Forest: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">dropped_features_rf</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final Train Data Shape: </span><span class="si">{</span><span class="n">X_train_selected</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Visualize Feature Importances</span>
<span class="n">importances</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">estimator_</span><span class="o">.</span><span class="n">feature_importances_</span>
<span class="n">selected_importances</span> <span class="o">=</span> <span class="n">importances</span><span class="p">[</span><span class="n">selector</span><span class="o">.</span><span class="n">get_support</span><span class="p">()]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">selected_features</span><span class="p">,</span> <span class="n">selected_importances</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Feature Importances (Random Forest)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Step 6: Train Logistic Regression Model</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_selected</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Predictions</span>
<span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train_selected</span><span class="p">)</span>
<span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_selected</span><span class="p">)</span>

<span class="n">f1_train</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
<span class="n">f1_test</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="n">cm_train</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
<span class="n">cm_test</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>

<span class="c1"># Print Confusion Matrices and F1 Scores</span>
<span class="n">tn_train</span><span class="p">,</span> <span class="n">fp_train</span><span class="p">,</span> <span class="n">fn_train</span><span class="p">,</span> <span class="n">tp_train</span> <span class="o">=</span> <span class="n">cm_train</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">tn_test</span><span class="p">,</span> <span class="n">fp_test</span><span class="p">,</span> <span class="n">fn_test</span><span class="p">,</span> <span class="n">tp_test</span> <span class="o">=</span> <span class="n">cm_test</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Train F1 Score: </span><span class="si">{</span><span class="n">f1_train</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test F1 Score: </span><span class="si">{</span><span class="n">f1_test</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training Confusion Matrix:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TP: </span><span class="si">{</span><span class="n">tp_train</span><span class="si">}</span><span class="s2">, TN: </span><span class="si">{</span><span class="n">tn_train</span><span class="si">}</span><span class="s2">, FP: </span><span class="si">{</span><span class="n">fp_train</span><span class="si">}</span><span class="s2">, FN: </span><span class="si">{</span><span class="n">fn_train</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Test Confusion Matrix:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;TP: </span><span class="si">{</span><span class="n">tp_test</span><span class="si">}</span><span class="s2">, TN: </span><span class="si">{</span><span class="n">tn_test</span><span class="si">}</span><span class="s2">, FP: </span><span class="si">{</span><span class="n">fp_test</span><span class="si">}</span><span class="s2">, FN: </span><span class="si">{</span><span class="n">fn_test</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Step 7: Log Results in MLFlow</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="s2">&quot;https://dagshub.com/rohanjain127/my-first-repo.mlflow&quot;</span><span class="p">)</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;Heart Disease Experiment&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="s2">&quot;LogisticRegression_FE_FSUsingThreshold&quot;</span><span class="p">):</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Train F1 Score&quot;</span><span class="p">,</span> <span class="n">f1_train</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Test F1 Score&quot;</span><span class="p">,</span> <span class="n">f1_test</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Train True Positives&quot;</span><span class="p">,</span> <span class="n">tp_train</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Train True Negatives&quot;</span><span class="p">,</span> <span class="n">tn_train</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Test True Positives&quot;</span><span class="p">,</span> <span class="n">tp_test</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Test True Negatives&quot;</span><span class="p">,</span> <span class="n">tn_test</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">&quot;Selected Features&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">selected_features</span><span class="p">))</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;Logistic Regression with Feature Engineering and Selection using Threshold&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Feature Selection Experiment completed and logged in MLFlow.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Initial Train Data Shape: (952, 22)
Initial Features: [&#39;age&#39;, &#39;resting_bp_s&#39;, &#39;cholesterol&#39;, &#39;max_heart_rate&#39;, &#39;oldpeak&#39;, &#39;bp_cholesterol_interaction&#39;, &#39;cholesterol_squared&#39;, &#39;bp_hr_ratio&#39;, &#39;combined_health_score&#39;, &#39;sex_1&#39;, &#39;fasting_blood_sugar_1&#39;, &#39;exercise_angina_1&#39;, &#39;chest_pain_type_2&#39;, &#39;chest_pain_type_3&#39;, &#39;chest_pain_type_4&#39;, &#39;resting_ecg_1&#39;, &#39;resting_ecg_2&#39;, &#39;st_slope_1&#39;, &#39;st_slope_2&#39;, &#39;st_slope_3&#39;, &#39;age_group_Senior&#39;, &#39;age_group_Young&#39;]

Features Kept After Variance Threshold: [&#39;age&#39;, &#39;resting_bp_s&#39;, &#39;cholesterol&#39;, &#39;max_heart_rate&#39;, &#39;oldpeak&#39;, &#39;bp_cholesterol_interaction&#39;, &#39;cholesterol_squared&#39;, &#39;bp_hr_ratio&#39;, &#39;combined_health_score&#39;, &#39;sex_1&#39;, &#39;fasting_blood_sugar_1&#39;, &#39;exercise_angina_1&#39;, &#39;chest_pain_type_2&#39;, &#39;chest_pain_type_3&#39;, &#39;chest_pain_type_4&#39;, &#39;resting_ecg_1&#39;, &#39;resting_ecg_2&#39;, &#39;st_slope_1&#39;, &#39;st_slope_2&#39;, &#39;st_slope_3&#39;, &#39;age_group_Senior&#39;, &#39;age_group_Young&#39;]
Features Dropped After Variance Threshold: []
After Variance Threshold: (952, 22)

Features Dropped Due to High Correlation: [&#39;bp_cholesterol_interaction&#39;, &#39;cholesterol_squared&#39;, &#39;bp_hr_ratio&#39;, &#39;combined_health_score&#39;, &#39;st_slope_2&#39;]
Features Kept After Correlation Threshold: [&#39;age&#39;, &#39;resting_bp_s&#39;, &#39;cholesterol&#39;, &#39;max_heart_rate&#39;, &#39;oldpeak&#39;, &#39;sex_1&#39;, &#39;fasting_blood_sugar_1&#39;, &#39;exercise_angina_1&#39;, &#39;chest_pain_type_2&#39;, &#39;chest_pain_type_3&#39;, &#39;chest_pain_type_4&#39;, &#39;resting_ecg_1&#39;, &#39;resting_ecg_2&#39;, &#39;st_slope_1&#39;, &#39;st_slope_3&#39;, &#39;age_group_Senior&#39;, &#39;age_group_Young&#39;]
After Correlation Threshold: (952, 17)

Selected Features by Random Forest: [&#39;age&#39;, &#39;resting_bp_s&#39;, &#39;cholesterol&#39;, &#39;max_heart_rate&#39;, &#39;oldpeak&#39;, &#39;sex_1&#39;, &#39;exercise_angina_1&#39;, &#39;chest_pain_type_4&#39;, &#39;st_slope_1&#39;]
Features Dropped by Random Forest: [&#39;age_group_Senior&#39;, &#39;age_group_Young&#39;, &#39;chest_pain_type_2&#39;, &#39;chest_pain_type_3&#39;, &#39;fasting_blood_sugar_1&#39;, &#39;resting_ecg_1&#39;, &#39;resting_ecg_2&#39;, &#39;st_slope_3&#39;]
Final Train Data Shape: (952, 9)
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/88/h6q1hd0558n2s59lz2g0xx640000gn/T/ipykernel_95383/4135417057.py:28: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing &#39;df[col].method(value, inplace=True)&#39;, try using &#39;df.method({col: value}, inplace=True)&#39; or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df[&#39;resting_bp_s&#39;].fillna(df[&#39;resting_bp_s&#39;].median(), inplace=True)
/var/folders/88/h6q1hd0558n2s59lz2g0xx640000gn/T/ipykernel_95383/4135417057.py:29: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing &#39;df[col].method(value, inplace=True)&#39;, try using &#39;df.method({col: value}, inplace=True)&#39; or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df[&#39;cholesterol&#39;].fillna(df[&#39;cholesterol&#39;].median(), inplace=True)
</pre></div>
</div>
<img alt="../_images/c1c8ee977b2fed59b031f5722e1ed77733aad8403e9b222feabd5d167ca7f563.png" src="../_images/c1c8ee977b2fed59b031f5722e1ed77733aad8403e9b222feabd5d167ca7f563.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Train F1 Score: 0.854043392504931
Test F1 Score: 0.8604651162790697

Training Confusion Matrix:
TP: 433, TN: 371, FP: 78, FN: 70

Test Confusion Matrix:
TP: 111, TN: 91, FP: 21, FN: 15
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Red">2024/12/21 18:32:28 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run LogisticRegression_FE_FSUsingThreshold at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/9f9c3312ef83473481ea93627e0d693f
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1

Feature Selection Experiment completed and logged in MLFlow.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_selected</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>resting_bp_s</th>
      <th>cholesterol</th>
      <th>max_heart_rate</th>
      <th>oldpeak</th>
      <th>sex_1</th>
      <th>exercise_angina_1</th>
      <th>chest_pain_type_4</th>
      <th>st_slope_1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-0.076988</td>
      <td>-1.518258</td>
      <td>-0.095409</td>
      <td>-0.969650</td>
      <td>-0.873002</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-1.359825</td>
      <td>0.152420</td>
      <td>-0.794037</td>
      <td>-0.303164</td>
      <td>-0.873002</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-0.183891</td>
      <td>-0.126026</td>
      <td>-1.228319</td>
      <td>0.010477</td>
      <td>0.529742</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.778236</td>
      <td>0.375177</td>
      <td>0.716510</td>
      <td>-0.185549</td>
      <td>-0.592453</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>-1.573631</td>
      <td>0.430866</td>
      <td>1.434020</td>
      <td>1.657089</td>
      <td>-0.873002</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Logistic Regression with Feature Engineering is slightly better, removing features did not help much</span>
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="experiment-5-use-pca-for-dimensionality-reduction-on-all-the-features-create-a-scree-plot-to-show-which-components-will-be-selected-for-classification-log-results-in-mlflow">
<h1>Experiment #5: Use PCA for dimensionality reduction on all the features. Create a scree plot to show which components will be selected for classification. Log results in MLFlow.<a class="headerlink" href="#experiment-5-use-pca-for-dimensionality-reduction-on-all-the-features-create-a-scree-plot-to-show-which-components-will-be-selected-for-classification-log-results-in-mlflow" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Approach 1: PCA after Feature Engineering</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">confusion_matrix</span>
<span class="kn">import</span> <span class="nn">mlflow</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Step 1: Data Loading and Cleaning</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df_combined</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">clean_column_names</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">clean_column_names</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;oldpeak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;oldpeak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;patient_id&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Step 2: Feature Engineering</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;bp_cholesterol_interaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;age_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Young&#39;</span><span class="p">,</span> <span class="s1">&#39;Middle-aged&#39;</span><span class="p">,</span> <span class="s1">&#39;Senior&#39;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol_squared&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;bp_hr_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;max_heart_rate&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;combined_health_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">,</span> <span class="s1">&#39;cholesterol&#39;</span><span class="p">,</span> <span class="s1">&#39;max_heart_rate&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># Step 3: Preprocessing</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;resting_bp_s&#39;</span><span class="p">,</span> <span class="s1">&#39;cholesterol&#39;</span><span class="p">,</span> <span class="s1">&#39;max_heart_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;oldpeak&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;bp_cholesterol_interaction&#39;</span><span class="p">,</span> <span class="s1">&#39;cholesterol_squared&#39;</span><span class="p">,</span> <span class="s1">&#39;bp_hr_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;combined_health_score&#39;</span><span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;fasting_blood_sugar&#39;</span><span class="p">,</span> <span class="s1">&#39;exercise_angina&#39;</span><span class="p">,</span> <span class="s1">&#39;chest_pain_type&#39;</span><span class="p">,</span> <span class="s1">&#39;resting_ecg&#39;</span><span class="p">,</span> <span class="s1">&#39;st_slope&#39;</span><span class="p">,</span> <span class="s1">&#39;age_group&#39;</span><span class="p">]</span>

<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
    <span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

<span class="n">encoded_columns</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s1">&#39;cat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)</span>
<span class="n">all_columns</span> <span class="o">=</span> <span class="n">numeric_features</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">encoded_columns</span><span class="p">)</span>

<span class="c1"># Convert X to DataFrame to retain column names</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">all_columns</span><span class="p">)</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># Print Features Before PCA</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Features Before PCA (After Feature Engineering) ---&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

<span class="c1"># Step 4: PCA</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
<span class="n">X_train_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_test_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># Convert PCA results to DataFrame</span>
<span class="n">X_train_pca</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_train_pca</span><span class="p">)</span>
<span class="n">X_test_pca</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X_test_pca</span><span class="p">)</span>

<span class="c1"># Scree Plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Number of Components&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Explained Variance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;PCA - Scree Plot (After Feature Engineering)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Identify Kept and Dropped Features</span>
<span class="n">kept_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
<span class="n">kept_feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">kept</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kept_features</span><span class="p">)</span> <span class="k">if</span> <span class="n">kept</span><span class="p">]</span>
<span class="n">dropped_feature_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">all_columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">kept</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">kept_features</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">kept</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Features Kept After PCA ---&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">kept_feature_names</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Features Dropped After PCA ---&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dropped_feature_names</span><span class="p">)</span>

<span class="c1"># Model Training</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_pca</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train_pca</span><span class="p">)</span>
<span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_pca</span><span class="p">)</span>

<span class="n">f1_train</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
<span class="n">f1_test</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="n">cm_train</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
<span class="n">cm_test</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training F1 Score:&quot;</span><span class="p">,</span> <span class="n">f1_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test F1 Score:&quot;</span><span class="p">,</span> <span class="n">f1_test</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Training Confusion Matrix:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cm_train</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test Confusion Matrix:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cm_test</span><span class="p">)</span>

<span class="c1"># MLFlow Logging</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">set_tracking_uri</span><span class="p">(</span><span class="s2">&quot;https://dagshub.com/rohanjain127/my-first-repo.mlflow&quot;</span><span class="p">)</span>
<span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;Heart Disease Experiment&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="s2">&quot;LogisticRegression_FE_PCA&quot;</span><span class="p">):</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Train F1 Score&quot;</span><span class="p">,</span> <span class="n">f1_train</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Test F1 Score&quot;</span><span class="p">,</span> <span class="n">f1_test</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">&quot;Kept Features&quot;</span><span class="p">,</span> <span class="n">kept_feature_names</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">&quot;Dropped Features&quot;</span><span class="p">,</span> <span class="n">dropped_feature_names</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">&quot;Logistic Regression with PCA&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">PCA Experiment Completed and Logged in MLFlow.&quot;</span><span class="p">)</span>

<span class="c1"># Check the head to confirm DataFrame format</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Head of X_train_pca (PCA-transformed DataFrame):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X_train_pca</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Features Before PCA (After Feature Engineering) ---
[&#39;age&#39;, &#39;resting_bp_s&#39;, &#39;cholesterol&#39;, &#39;max_heart_rate&#39;, &#39;oldpeak&#39;, &#39;bp_cholesterol_interaction&#39;, &#39;cholesterol_squared&#39;, &#39;bp_hr_ratio&#39;, &#39;combined_health_score&#39;, &#39;sex_1&#39;, &#39;fasting_blood_sugar_1&#39;, &#39;exercise_angina_1&#39;, &#39;chest_pain_type_2&#39;, &#39;chest_pain_type_3&#39;, &#39;chest_pain_type_4&#39;, &#39;resting_ecg_1&#39;, &#39;resting_ecg_2&#39;, &#39;st_slope_1&#39;, &#39;st_slope_2&#39;, &#39;st_slope_3&#39;, &#39;age_group_Senior&#39;, &#39;age_group_Young&#39;]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/88/h6q1hd0558n2s59lz2g0xx640000gn/T/ipykernel_95383/2527746417.py:25: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing &#39;df[col].method(value, inplace=True)&#39;, try using &#39;df.method({col: value}, inplace=True)&#39; or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df[&#39;resting_bp_s&#39;].fillna(df[&#39;resting_bp_s&#39;].median(), inplace=True)
/var/folders/88/h6q1hd0558n2s59lz2g0xx640000gn/T/ipykernel_95383/2527746417.py:26: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing &#39;df[col].method(value, inplace=True)&#39;, try using &#39;df.method({col: value}, inplace=True)&#39; or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df[&#39;cholesterol&#39;].fillna(df[&#39;cholesterol&#39;].median(), inplace=True)
</pre></div>
</div>
<img alt="../_images/5c1cac3cfe8b0b2c7d2e75de4b255ef6b9bb765efd629317310095605dcef464.png" src="../_images/5c1cac3cfe8b0b2c7d2e75de4b255ef6b9bb765efd629317310095605dcef464.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Features Kept After PCA ---
[&#39;age&#39;, &#39;resting_bp_s&#39;, &#39;cholesterol&#39;, &#39;max_heart_rate&#39;, &#39;oldpeak&#39;, &#39;bp_cholesterol_interaction&#39;, &#39;cholesterol_squared&#39;, &#39;bp_hr_ratio&#39;, &#39;combined_health_score&#39;, &#39;sex_1&#39;, &#39;fasting_blood_sugar_1&#39;, &#39;exercise_angina_1&#39;, &#39;chest_pain_type_2&#39;, &#39;chest_pain_type_3&#39;, &#39;chest_pain_type_4&#39;, &#39;resting_ecg_1&#39;, &#39;resting_ecg_2&#39;, &#39;st_slope_1&#39;, &#39;st_slope_2&#39;, &#39;st_slope_3&#39;, &#39;age_group_Senior&#39;, &#39;age_group_Young&#39;]

--- Features Dropped After PCA ---
[]

Training F1 Score: 0.8686274509803922
Test F1 Score: 0.8671875

Training Confusion Matrix:
 [[375  74]
 [ 60 443]]
Test Confusion Matrix:
 [[ 93  19]
 [ 15 111]]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Red">2024/12/21 18:32:41 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run LogisticRegression_FE_PCA at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/4014f5493c164df1a76f180e2c359a7f
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1

PCA Experiment Completed and Logged in MLFlow.

Head of X_train_pca (PCA-transformed DataFrame):
         0         1         2         3         4         5         6   \
0 -1.487479 -0.143880 -1.122302 -1.468031  0.316612 -0.138566  1.171445   
1 -1.537171 -0.175664  0.802254 -0.873281 -1.024205  0.239679  0.713044   
2 -2.050476  0.654371 -0.301126  0.646449 -0.550000  0.637886  0.075242   
3  1.356447 -0.129392  0.613932 -0.610048  1.092227 -0.629527 -0.373337   
4  2.547173 -3.164567  0.967498 -0.016722 -0.638611 -0.195721  0.376641   

         7         8         9         10  
0 -0.134085 -0.219855  0.097914 -0.206500  
1  0.281408  0.692217  0.718620 -0.259801  
2  0.211490  0.577442 -0.755914  0.123603  
3 -0.013518  0.509381  0.507677 -0.469235  
4  0.107828 -1.046566 -0.035308 -0.175163  
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train_pca</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>10</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>-1.487479</td>
      <td>-0.143880</td>
      <td>-1.122302</td>
      <td>-1.468031</td>
      <td>0.316612</td>
      <td>-0.138566</td>
      <td>1.171445</td>
      <td>-0.134085</td>
      <td>-0.219855</td>
      <td>0.097914</td>
      <td>-0.206500</td>
    </tr>
    <tr>
      <th>1</th>
      <td>-1.537171</td>
      <td>-0.175664</td>
      <td>0.802254</td>
      <td>-0.873281</td>
      <td>-1.024205</td>
      <td>0.239679</td>
      <td>0.713044</td>
      <td>0.281408</td>
      <td>0.692217</td>
      <td>0.718620</td>
      <td>-0.259801</td>
    </tr>
    <tr>
      <th>2</th>
      <td>-2.050476</td>
      <td>0.654371</td>
      <td>-0.301126</td>
      <td>0.646449</td>
      <td>-0.550000</td>
      <td>0.637886</td>
      <td>0.075242</td>
      <td>0.211490</td>
      <td>0.577442</td>
      <td>-0.755914</td>
      <td>0.123603</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.356447</td>
      <td>-0.129392</td>
      <td>0.613932</td>
      <td>-0.610048</td>
      <td>1.092227</td>
      <td>-0.629527</td>
      <td>-0.373337</td>
      <td>-0.013518</td>
      <td>0.509381</td>
      <td>0.507677</td>
      <td>-0.469235</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2.547173</td>
      <td>-3.164567</td>
      <td>0.967498</td>
      <td>-0.016722</td>
      <td>-0.638611</td>
      <td>-0.195721</td>
      <td>0.376641</td>
      <td>0.107828</td>
      <td>-1.046566</td>
      <td>-0.035308</td>
      <td>-0.175163</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Apply PCA to the training data</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">()</span>
<span class="n">X_train_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>

<span class="c1"># Explained variance ratio</span>
<span class="n">explained_variance_ratio</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span>

<span class="c1"># Calculate cumulative variance</span>
<span class="n">cumulative_variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">explained_variance_ratio</span><span class="p">)</span>

<span class="c1"># Plot the explained variance ratio</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">explained_variance_ratio</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">cumulative_variance</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Number of Principal Components&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Explained Variance&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;PCA Scree Plot&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Print variance ratios</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">var_ratio</span><span class="p">,</span> <span class="n">cum_var</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">explained_variance_ratio</span><span class="p">,</span> <span class="n">cumulative_variance</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PC </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: Explained Variance Ratio: </span><span class="si">{</span><span class="n">var_ratio</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, Cumulative Variance: </span><span class="si">{</span><span class="n">cum_var</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/cc2c41f0b3dfc14fc664e62c156b20f35e39b426fcb94a56177e9477ed15648f.png" src="../_images/cc2c41f0b3dfc14fc664e62c156b20f35e39b426fcb94a56177e9477ed15648f.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PC 1: Explained Variance Ratio: 0.3434, Cumulative Variance: 0.3434
PC 2: Explained Variance Ratio: 0.2397, Cumulative Variance: 0.5831
PC 3: Explained Variance Ratio: 0.0927, Cumulative Variance: 0.6758
PC 4: Explained Variance Ratio: 0.0877, Cumulative Variance: 0.7635
PC 5: Explained Variance Ratio: 0.0711, Cumulative Variance: 0.8347
PC 6: Explained Variance Ratio: 0.0293, Cumulative Variance: 0.8639
PC 7: Explained Variance Ratio: 0.0261, Cumulative Variance: 0.8901
PC 8: Explained Variance Ratio: 0.0181, Cumulative Variance: 0.9081
PC 9: Explained Variance Ratio: 0.0169, Cumulative Variance: 0.9250
PC 10: Explained Variance Ratio: 0.0139, Cumulative Variance: 0.9389
PC 11: Explained Variance Ratio: 0.0135, Cumulative Variance: 0.9523
PC 12: Explained Variance Ratio: 0.0118, Cumulative Variance: 0.9641
PC 13: Explained Variance Ratio: 0.0091, Cumulative Variance: 0.9732
PC 14: Explained Variance Ratio: 0.0087, Cumulative Variance: 0.9820
PC 15: Explained Variance Ratio: 0.0065, Cumulative Variance: 0.9885
PC 16: Explained Variance Ratio: 0.0035, Cumulative Variance: 0.9919
PC 17: Explained Variance Ratio: 0.0031, Cumulative Variance: 0.9950
PC 18: Explained Variance Ratio: 0.0029, Cumulative Variance: 0.9980
PC 19: Explained Variance Ratio: 0.0015, Cumulative Variance: 0.9994
PC 20: Explained Variance Ratio: 0.0006, Cumulative Variance: 1.0000
PC 21: Explained Variance Ratio: 0.0000, Cumulative Variance: 1.0000
PC 22: Explained Variance Ratio: 0.0000, Cumulative Variance: 1.0000
</pre></div>
</div>
</div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="experiment-6-design-a-nd-execute-a-custom-experiment-log-results-in-mlflow">
<h1>Experiment #6: Design a nd execute a custom experiment. Log results in MLFlow.<a class="headerlink" href="#experiment-6-design-a-nd-execute-a-custom-experiment-log-results-in-mlflow" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span><span class="p">,</span> <span class="n">RidgeClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span><span class="p">,</span> <span class="n">GradientBoostingClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">SVC</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_selection</span> <span class="kn">import</span> <span class="n">SelectFromModel</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">confusion_matrix</span>
<span class="kn">import</span> <span class="nn">mlflow</span>

<span class="c1"># ----- Load Data -----</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df_combined</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">clean_column_names</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">clean_column_names</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># ----- Data Cleaning -----</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;oldpeak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;oldpeak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;patient_id&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># ----- Feature Engineering -----</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;bp_cholesterol_interaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol_squared&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;bp_hr_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;max_heart_rate&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;combined_health_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">,</span> <span class="s1">&#39;cholesterol&#39;</span><span class="p">,</span> <span class="s1">&#39;max_heart_rate&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;age_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Young&#39;</span><span class="p">,</span> <span class="s1">&#39;Middle-aged&#39;</span><span class="p">,</span> <span class="s1">&#39;Senior&#39;</span><span class="p">])</span>

<span class="c1"># ----- Preprocessing -----</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;resting_bp_s&#39;</span><span class="p">,</span> <span class="s1">&#39;cholesterol&#39;</span><span class="p">,</span> <span class="s1">&#39;max_heart_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;oldpeak&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;bp_cholesterol_interaction&#39;</span><span class="p">,</span> <span class="s1">&#39;cholesterol_squared&#39;</span><span class="p">,</span> <span class="s1">&#39;bp_hr_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;combined_health_score&#39;</span><span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;fasting_blood_sugar&#39;</span><span class="p">,</span> <span class="s1">&#39;exercise_angina&#39;</span><span class="p">,</span> <span class="s1">&#39;chest_pain_type&#39;</span><span class="p">,</span> <span class="s1">&#39;resting_ecg&#39;</span><span class="p">,</span> <span class="s1">&#39;st_slope&#39;</span><span class="p">,</span> <span class="s1">&#39;age_group&#39;</span><span class="p">]</span>

<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
    <span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s1">&#39;cat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)))</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>


<span class="c1"># ----- Experiment 6 and 7 Classifiers -----</span>
<span class="n">classifiers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;LogisticRegression_FE2nd&quot;</span><span class="p">:</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="s2">&quot;RidgeClassifier_FE&quot;</span><span class="p">:</span> <span class="n">RidgeClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="s2">&quot;RandomForestClassifier_FE&quot;</span><span class="p">:</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="s2">&quot;XGBClassifier_FE&quot;</span><span class="p">:</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="s2">&quot;KNeighborsClassifier_FE&quot;</span><span class="p">:</span> <span class="n">KNeighborsClassifier</span><span class="p">(),</span>
    <span class="s2">&quot;SVC_FE&quot;</span><span class="p">:</span> <span class="n">SVC</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;rbf&#39;</span><span class="p">,</span> <span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="s2">&quot;GradientBoostingClassifier_FE&quot;</span><span class="p">:</span> <span class="n">GradientBoostingClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="p">}</span>


<span class="c1"># ----- Experiment 6: Feature Engineering Only -----</span>
<span class="k">def</span> <span class="nf">run_experiment_6</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Experiment 6: Feature Engineering Only ---&quot;</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;Heart Disease Experiment&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">classifiers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([(</span><span class="s1">&#39;classifier&#39;</span><span class="p">,</span> <span class="n">model</span><span class="p">)])</span>
        <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
        <span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

        <span class="n">f1_train</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
        <span class="n">f1_test</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
        <span class="n">cm_train</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
        <span class="n">cm_test</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (Feature Engineering):&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train F1 Score: </span><span class="si">{</span><span class="n">f1_train</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test F1 Score: </span><span class="si">{</span><span class="n">f1_test</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Train F1 Score&quot;</span><span class="p">,</span> <span class="n">f1_train</span><span class="p">)</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Test F1 Score&quot;</span><span class="p">,</span> <span class="n">f1_test</span><span class="p">)</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">&quot;Classifier&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_FE&quot;</span><span class="p">)</span>

<span class="n">run_experiment_6</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Experiment 6: Feature Engineering Only ---
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/88/h6q1hd0558n2s59lz2g0xx640000gn/T/ipykernel_95383/1222561477.py:30: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing &#39;df[col].method(value, inplace=True)&#39;, try using &#39;df.method({col: value}, inplace=True)&#39; or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df[&#39;resting_bp_s&#39;].fillna(df[&#39;resting_bp_s&#39;].median(), inplace=True)
/var/folders/88/h6q1hd0558n2s59lz2g0xx640000gn/T/ipykernel_95383/1222561477.py:31: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing &#39;df[col].method(value, inplace=True)&#39;, try using &#39;df.method({col: value}, inplace=True)&#39; or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df[&#39;cholesterol&#39;].fillna(df[&#39;cholesterol&#39;].median(), inplace=True)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LogisticRegression_FE2nd (Feature Engineering):
Train F1 Score: 0.8644400785854617
Test F1 Score: 0.875
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Red">2024/12/21 18:32:54 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run LogisticRegression_FE2nd at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/e860d10ccd5e4c5aaed5360da3a58679
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1

RidgeClassifier_FE (Feature Engineering):
Train F1 Score: 0.8565815324165029
Test F1 Score: 0.8715953307392996
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Red">2024/12/21 18:33:07 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run RidgeClassifier_FE at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/4f33736dd0084f49a046d05323b2fb40
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1

RandomForestClassifier_FE (Feature Engineering):
Train F1 Score: 1.0
Test F1 Score: 0.9173553719008265
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Red">2024/12/21 18:33:20 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run RandomForestClassifier_FE at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/f746ea05606a48e58f244c8b1afb1d5a
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1

XGBClassifier_FE (Feature Engineering):
Train F1 Score: 1.0
Test F1 Score: 0.9156626506024096
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Red">2024/12/21 18:33:33 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run XGBClassifier_FE at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/41ce2947e2ab4a54a2391a5facf78341
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1

KNeighborsClassifier_FE (Feature Engineering):
Train F1 Score: 0.8888888888888888
Test F1 Score: 0.8790322580645161
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Red">2024/12/21 18:33:46 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run KNeighborsClassifier_FE at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/9ee7f4f15a1c4724b5c75b3ac8ce1485
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1

SVC_FE (Feature Engineering):
Train F1 Score: 0.899009900990099
Test F1 Score: 0.8995983935742972
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Red">2024/12/21 18:33:59 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run SVC_FE at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/cdd4a4a7af9040c39e26a39af37cc676
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1

GradientBoostingClassifier_FE (Feature Engineering):
Train F1 Score: 0.95703125
Test F1 Score: 0.9212598425196851
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Red">2024/12/21 18:34:12 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run GradientBoostingClassifier_FE at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/beb9f84071544bdcbec513f638fec42b
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>resting_bp_s</th>
      <th>cholesterol</th>
      <th>max_heart_rate</th>
      <th>oldpeak</th>
      <th>bp_cholesterol_interaction</th>
      <th>cholesterol_squared</th>
      <th>bp_hr_ratio</th>
      <th>combined_health_score</th>
      <th>sex_1</th>
      <th>...</th>
      <th>chest_pain_type_2</th>
      <th>chest_pain_type_3</th>
      <th>chest_pain_type_4</th>
      <th>resting_ecg_1</th>
      <th>resting_ecg_2</th>
      <th>st_slope_1</th>
      <th>st_slope_2</th>
      <th>st_slope_3</th>
      <th>age_group_Senior</th>
      <th>age_group_Young</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>360</th>
      <td>-0.076988</td>
      <td>-1.518258</td>
      <td>-0.095409</td>
      <td>-0.969650</td>
      <td>-0.873002</td>
      <td>-0.834938</td>
      <td>-0.171930</td>
      <td>-0.276076</td>
      <td>-0.915600</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>842</th>
      <td>-1.359825</td>
      <td>0.152420</td>
      <td>-0.794037</td>
      <td>-0.303164</td>
      <td>-0.873002</td>
      <td>-0.583067</td>
      <td>-0.708119</td>
      <td>0.140063</td>
      <td>-0.755106</td>
      <td>1.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>54</th>
      <td>-0.183891</td>
      <td>-0.126026</td>
      <td>-1.228319</td>
      <td>0.010477</td>
      <td>0.529742</td>
      <td>-1.040548</td>
      <td>-0.996283</td>
      <td>-0.217163</td>
      <td>-1.076095</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>528</th>
      <td>0.778236</td>
      <td>0.375177</td>
      <td>0.716510</td>
      <td>-0.185549</td>
      <td>-0.592453</td>
      <td>0.779895</td>
      <td>0.563739</td>
      <td>0.166251</td>
      <td>0.641195</td>
      <td>1.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>969</th>
      <td>-1.573631</td>
      <td>0.430866</td>
      <td>1.434020</td>
      <td>1.657089</td>
      <td>-0.873002</td>
      <td>1.419912</td>
      <td>1.314555</td>
      <td>-0.821699</td>
      <td>2.021448</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 22 columns</p>
</div></div></div>
</div>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="experiment-7-design-and-execute-another-custom-experiment-log-results-in-mlflow">
<h1>Experiment #7: Design and execute another custom experiment. Log results in MLFlow.<a class="headerlink" href="#experiment-7-design-and-execute-another-custom-experiment-log-results-in-mlflow" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span><span class="p">,</span> <span class="n">OneHotEncoder</span>
<span class="kn">from</span> <span class="nn">sklearn.compose</span> <span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span><span class="p">,</span> <span class="n">RidgeClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span><span class="p">,</span> <span class="n">GradientBoostingClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.svm</span> <span class="kn">import</span> <span class="n">SVC</span>
<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_selection</span> <span class="kn">import</span> <span class="n">SelectFromModel</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">f1_score</span><span class="p">,</span> <span class="n">confusion_matrix</span>
<span class="kn">import</span> <span class="nn">mlflow</span>

<span class="c1"># ----- Load Data -----</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df_combined</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">clean_column_names</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">clean_column_names</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="c1"># ----- Data Cleaning -----</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;oldpeak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;oldpeak&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;patient_id&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># ----- Feature Engineering -----</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;bp_cholesterol_interaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol_squared&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cholesterol&#39;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;bp_hr_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;max_heart_rate&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;combined_health_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;resting_bp_s&#39;</span><span class="p">,</span> <span class="s1">&#39;cholesterol&#39;</span><span class="p">,</span> <span class="s1">&#39;max_heart_rate&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;age_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Young&#39;</span><span class="p">,</span> <span class="s1">&#39;Middle-aged&#39;</span><span class="p">,</span> <span class="s1">&#39;Senior&#39;</span><span class="p">])</span>

<span class="c1"># ----- Preprocessing -----</span>
<span class="n">numeric_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;resting_bp_s&#39;</span><span class="p">,</span> <span class="s1">&#39;cholesterol&#39;</span><span class="p">,</span> <span class="s1">&#39;max_heart_rate&#39;</span><span class="p">,</span> <span class="s1">&#39;oldpeak&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;bp_cholesterol_interaction&#39;</span><span class="p">,</span> <span class="s1">&#39;cholesterol_squared&#39;</span><span class="p">,</span> <span class="s1">&#39;bp_hr_ratio&#39;</span><span class="p">,</span> <span class="s1">&#39;combined_health_score&#39;</span><span class="p">]</span>
<span class="n">categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sex&#39;</span><span class="p">,</span> <span class="s1">&#39;fasting_blood_sugar&#39;</span><span class="p">,</span> <span class="s1">&#39;exercise_angina&#39;</span><span class="p">,</span> <span class="s1">&#39;chest_pain_type&#39;</span><span class="p">,</span> <span class="s1">&#39;resting_ecg&#39;</span><span class="p">,</span> <span class="s1">&#39;st_slope&#39;</span><span class="p">,</span> <span class="s1">&#39;age_group&#39;</span><span class="p">]</span>

<span class="n">numeric_transformer</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">categorical_transformer</span> <span class="o">=</span> <span class="n">OneHotEncoder</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="n">sparse_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
    <span class="n">transformers</span><span class="o">=</span><span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;num&#39;</span><span class="p">,</span> <span class="n">numeric_transformer</span><span class="p">,</span> <span class="n">numeric_features</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">categorical_transformer</span><span class="p">,</span> <span class="n">categorical_features</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">preprocessor</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">numeric_features</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">preprocessor</span><span class="o">.</span><span class="n">named_transformers_</span><span class="p">[</span><span class="s1">&#39;cat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">(</span><span class="n">categorical_features</span><span class="p">)))</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">stratify</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>


<span class="n">classifiers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;LogisticRegression_FE_PCA2nd&quot;</span><span class="p">:</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="s2">&quot;RidgeClassifier_FE_PCA&quot;</span><span class="p">:</span> <span class="n">RidgeClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="s2">&quot;RandomForestClassifier_FE_PCA&quot;</span><span class="p">:</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="s2">&quot;XGBClassifier_FE_PCA&quot;</span><span class="p">:</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eval_metric</span><span class="o">=</span><span class="s1">&#39;logloss&#39;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="s2">&quot;KNeighborsClassifier_FE_PCA&quot;</span><span class="p">:</span> <span class="n">KNeighborsClassifier</span><span class="p">(),</span>
    <span class="s2">&quot;SVC_FE_PCA&quot;</span><span class="p">:</span> <span class="n">SVC</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;rbf&#39;</span><span class="p">,</span> <span class="n">probability</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
    <span class="s2">&quot;GradientBoostingClassifier_FE_PCA&quot;</span><span class="p">:</span> <span class="n">GradientBoostingClassifier</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="p">}</span>
<span class="c1"># ----- Experiment 7: Feature Engineering + Feature Selection + PCA -----</span>
<span class="k">def</span> <span class="nf">run_experiment_7</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Experiment 7: Feature Selection and PCA ---&quot;</span><span class="p">)</span>
    <span class="n">mlflow</span><span class="o">.</span><span class="n">set_experiment</span><span class="p">(</span><span class="s2">&quot;Heart Disease Experiment&quot;</span><span class="p">)</span>

    <span class="c1"># Feature Selection</span>
    <span class="n">selector</span> <span class="o">=</span> <span class="n">SelectFromModel</span><span class="p">(</span><span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span> <span class="n">threshold</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span>
    <span class="n">X_train_selected</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">X_test_selected</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

    <span class="c1"># PCA</span>
    <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>  <span class="c1"># Keep 95% variance</span>
    <span class="n">X_train_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_selected</span><span class="p">)</span>
    <span class="n">X_test_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_selected</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">PCA Components Retained:&quot;</span><span class="p">,</span> <span class="n">pca</span><span class="o">.</span><span class="n">n_components_</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">classifiers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_pca</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

        <span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_train_pca</span><span class="p">)</span>
        <span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_pca</span><span class="p">)</span>

        <span class="n">f1_train</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
        <span class="n">f1_test</span> <span class="o">=</span> <span class="n">f1_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> (Feature Selection + PCA):&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train F1 Score: </span><span class="si">{</span><span class="n">f1_train</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Test F1 Score: </span><span class="si">{</span><span class="n">f1_test</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">mlflow</span><span class="o">.</span><span class="n">start_run</span><span class="p">(</span><span class="n">run_name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">):</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Train F1 Score&quot;</span><span class="p">,</span> <span class="n">f1_train</span><span class="p">)</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_metric</span><span class="p">(</span><span class="s2">&quot;Test F1 Score&quot;</span><span class="p">,</span> <span class="n">f1_test</span><span class="p">)</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">log_param</span><span class="p">(</span><span class="s2">&quot;Classifier&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">mlflow</span><span class="o">.</span><span class="n">sklearn</span><span class="o">.</span><span class="n">log_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_FE_FS_PCA&quot;</span><span class="p">)</span>

<span class="n">run_experiment_7</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/var/folders/88/h6q1hd0558n2s59lz2g0xx640000gn/T/ipykernel_95383/2700528972.py:30: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing &#39;df[col].method(value, inplace=True)&#39;, try using &#39;df.method({col: value}, inplace=True)&#39; or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df[&#39;resting_bp_s&#39;].fillna(df[&#39;resting_bp_s&#39;].median(), inplace=True)
/var/folders/88/h6q1hd0558n2s59lz2g0xx640000gn/T/ipykernel_95383/2700528972.py:31: FutureWarning: A value is trying to be set on a copy of a DataFrame or Series through chained assignment using an inplace method.
The behavior will change in pandas 3.0. This inplace method will never work because the intermediate object on which we are setting values always behaves as a copy.

For example, when doing &#39;df[col].method(value, inplace=True)&#39;, try using &#39;df.method({col: value}, inplace=True)&#39; or df[col] = df[col].method(value) instead, to perform the operation inplace on the original object.


  df[&#39;cholesterol&#39;].fillna(df[&#39;cholesterol&#39;].median(), inplace=True)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Experiment 7: Feature Selection and PCA ---

PCA Components Retained: 6

LogisticRegression_FE_PCA2nd (Feature Selection + PCA):
Train F1 Score: 0.8244575936883629
Test F1 Score: 0.84
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Red">2024/12/21 18:34:25 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run LogisticRegression_FE_PCA2nd at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/d64fbbc76daf45f2a0e290e93ebd8cab
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1

RidgeClassifier_FE_PCA (Feature Selection + PCA):
Train F1 Score: 0.8170128585558852
Test F1 Score: 0.8616600790513834
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Red">2024/12/21 18:34:38 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run RidgeClassifier_FE_PCA at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/8bcbe505ead2443db128b04828d92469
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1

RandomForestClassifier_FE_PCA (Feature Selection + PCA):
Train F1 Score: 1.0
Test F1 Score: 0.9230769230769231
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Red">2024/12/21 18:34:51 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run RandomForestClassifier_FE_PCA at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/a41e24f5ee4546eebac339dc03593c27
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1

XGBClassifier_FE_PCA (Feature Selection + PCA):
Train F1 Score: 1.0
Test F1 Score: 0.8925619834710744
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Red">2024/12/21 18:35:04 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run XGBClassifier_FE_PCA at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/9c7bebbc1fa44ec3bb0dd5083a4615b2
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1

KNeighborsClassifier_FE_PCA (Feature Selection + PCA):
Train F1 Score: 0.8712871287128713
Test F1 Score: 0.8433734939759037
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Red">2024/12/21 18:35:17 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run KNeighborsClassifier_FE_PCA at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/ae6dcbc8265748179cd0ce350605541f
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1

SVC_FE_PCA (Feature Selection + PCA):
Train F1 Score: 0.84765625
Test F1 Score: 0.8571428571428571
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Red">2024/12/21 18:35:30 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run SVC_FE_PCA at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/1455519a5b8340c2975ce2b3a4e41b93
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1

GradientBoostingClassifier_FE_PCA (Feature Selection + PCA):
Train F1 Score: 0.9322865554465162
Test F1 Score: 0.8629032258064516
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Red">2024/12/21 18:35:43 WARNING mlflow.models.model: Model logged without a signature and input example. Please set `input_example` parameter when logging the model to auto infer the model signature.</span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🏃 View run GradientBoostingClassifier_FE_PCA at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1/runs/243ec534392843b0909f9f43a85d9a76
🧪 View experiment at: https://dagshub.com/rohanjain127/my-first-repo.mlflow/#/experiments/1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>age</th>
      <th>resting_bp_s</th>
      <th>cholesterol</th>
      <th>max_heart_rate</th>
      <th>oldpeak</th>
      <th>bp_cholesterol_interaction</th>
      <th>cholesterol_squared</th>
      <th>bp_hr_ratio</th>
      <th>combined_health_score</th>
      <th>sex_1</th>
      <th>...</th>
      <th>chest_pain_type_2</th>
      <th>chest_pain_type_3</th>
      <th>chest_pain_type_4</th>
      <th>resting_ecg_1</th>
      <th>resting_ecg_2</th>
      <th>st_slope_1</th>
      <th>st_slope_2</th>
      <th>st_slope_3</th>
      <th>age_group_Senior</th>
      <th>age_group_Young</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>360</th>
      <td>-0.076988</td>
      <td>-1.518258</td>
      <td>-0.095409</td>
      <td>-0.969650</td>
      <td>-0.873002</td>
      <td>-0.834938</td>
      <td>-0.171930</td>
      <td>-0.276076</td>
      <td>-0.915600</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>842</th>
      <td>-1.359825</td>
      <td>0.152420</td>
      <td>-0.794037</td>
      <td>-0.303164</td>
      <td>-0.873002</td>
      <td>-0.583067</td>
      <td>-0.708119</td>
      <td>0.140063</td>
      <td>-0.755106</td>
      <td>1.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>54</th>
      <td>-0.183891</td>
      <td>-0.126026</td>
      <td>-1.228319</td>
      <td>0.010477</td>
      <td>0.529742</td>
      <td>-1.040548</td>
      <td>-0.996283</td>
      <td>-0.217163</td>
      <td>-1.076095</td>
      <td>0.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>528</th>
      <td>0.778236</td>
      <td>0.375177</td>
      <td>0.716510</td>
      <td>-0.185549</td>
      <td>-0.592453</td>
      <td>0.779895</td>
      <td>0.563739</td>
      <td>0.166251</td>
      <td>0.641195</td>
      <td>1.0</td>
      <td>...</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>969</th>
      <td>-1.573631</td>
      <td>0.430866</td>
      <td>1.434020</td>
      <td>1.657089</td>
      <td>-0.873002</td>
      <td>1.419912</td>
      <td>1.314555</td>
      <td>-0.821699</td>
      <td>2.021448</td>
      <td>1.0</td>
      <td>...</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 22 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Step 6: Select and Save the Best Model</span>
<span class="n">best_model</span> <span class="o">=</span> <span class="n">trained_models</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;XGBClassifier1st&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Use .get() to avoid KeyError</span>

<span class="k">if</span> <span class="n">best_model</span><span class="p">:</span>
    <span class="n">model_path</span> <span class="o">=</span> <span class="s1">&#39;/Users/rohanjain/Desktop/Sem1/Prog_DB/Final_project/heart_disease_best_model.joblib&#39;</span>
    <span class="n">joblib</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">model_path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Best Model (XGBClassifier1st) saved to: </span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;XGBClassifier1st not found in trained models.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Best Model (XGBClassifier1st) saved to: /Users/rohanjain/Desktop/Sem1/Prog_DB/Final_project/heart_disease_best_model.joblib
</pre></div>
</div>
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./project"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="project_overview.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Heart Disease Prediction Project</p>
      </div>
    </a>
    <a class="right-next"
       href="../resources/links.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Project Resources and Links</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Project Code (Heart Disease Prediction)</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#create-a-normalized-database-3nf">Create a normalized database (3NF).</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#write-sql-join-statement-to-fetch-data-from-the-database-and-into-pandas-dataframe">Write SQL join statement to fetch data from the database and into Pandas DataFrame.</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#explore-the-data-using-yprofile-and-correlation-matrix-make-observations-about-features-distributions-capped-values-and-missing-values-create-a-list-of-data-cleanup-tasks">Explore the data using yprofile and correlation matrix. Make observations about features, distributions, capped values, and missing values. Create a list of data cleanup tasks.</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#explore-the-data-to-determine-if-you-need-to-stratify-it-by-some-attribute-when-doing-train-test-split-perform-the-train-test-split">Explore the data to determine if you need to stratify it by some attribute when doing train/test split. Perform the train/test split.</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-1-create-a-pipeline-for-preprocessing-standardscaler-minmaxscaler-logtransformation-onehotencoding-and-logistic-regression-log-f1-score-tp-tn-fn-fp-in-mlflow-on-dagshub-cross-validation-3-10-folds-resultsmean-std-of-cv-results-and-results-on-the-whole-training-data-add-in-parameter-hyper-tuning">Experiment #1: Create a pipeline for preprocessing (StandardScaler, MinMaxScaler, LogTransformation, OneHotEncoding) and Logistic Regression. Log F1-score/(TP,TN,FN,FP)  in MLFlow on DagsHub. – Cross validation 3/10 folds. Results—mean/std of CV results and results on the whole training data – add in parameter hyper tuning</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-2-create-a-pipeline-for-preprocessing-and-use-logisticregression-ridgeclassifier-randomforestclassifier-and-xgbclassifier-log-results-in-mlflow-on-dagshub">Experiment #2: Create a pipeline for preprocessing and use LogisticRegression, RidgeClassifier, RandomForestClassifier, and XGBClassifier. Log results in MLFlow on DagsHub.</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-3-perform-feature-engineering-and-attribute-combination-log-results-in-mlflow">Experiment #3: Perform feature engineering and attribute combination. Log results in MLFlow.</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-4-perform-feature-selection-using-correlation-threshold-feature-importance-and-variance-threshold-log-results-in-mlflow">Experiment #4: Perform feature selection using Correlation Threshold, Feature Importance, and Variance Threshold. Log results in MLFlow.</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-5-use-pca-for-dimensionality-reduction-on-all-the-features-create-a-scree-plot-to-show-which-components-will-be-selected-for-classification-log-results-in-mlflow">Experiment #5: Use PCA for dimensionality reduction on all the features. Create a scree plot to show which components will be selected for classification. Log results in MLFlow.</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-6-design-a-nd-execute-a-custom-experiment-log-results-in-mlflow">Experiment #6: Design a nd execute a custom experiment. Log results in MLFlow.</a></li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#experiment-7-design-and-execute-another-custom-experiment-log-results-in-mlflow">Experiment #7: Design and execute another custom experiment. Log results in MLFlow.</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Rohan Jain
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>